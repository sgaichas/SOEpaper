---
title: "State of the Ecosystem: So What? Improving ecosystem reporting for fisheries managers in the Northeast US"
author:
  - name: Sarah K. Gaichas
    email: Sarah.Gaichas@noaa.gov
    affiliation: NEFSCWH
    corresponding: Sarah.Gaichas@noaa.gov
  - name: Sean B. Hardison
    email: Sean.Hardison@noaa.gov
    affiliation: [IS,NEFSCWH]
  - name: Sean M. Lucey
    email: Sean.Lucey@noaa.gov
    affiliation: NEFSCWH
  - name: Geret S. DePiper
    email: Geret.DePiper@noaa.gov
    affiliation: NEFSCWH
  - name: Patricia M. Clay
    email: Patricia.Clay@noaa.gov
    affiliation: NEFSCSS
  - name: Lisa L. Colburn
    email: Lisa.Colburn@noaa.gov
    affiliation: NEFSCRI
  - name: Deb Duarte
    email: Debra.Duarte@noaa.gov
    affiliation: NEFSCWH
  - name: Michael J. Fogarty
    email: Michael.Fogarty@noaa.gov
    affiliation: NEFSCWH
  - name: Kevin D. Friedland
    email: Kevin.Friedland@noaa.gov
    affiliation: NEFSCRI
  - name: Robert J. Gamble
    email: Robert.Gamble@noaa.gov
    affiliation: NEFSCWH
  - name: Kimberly J. W. Hyde
    email: Kimberly.Hyde@noaa.gov
    affiliation: NEFSCRI
  - name: D. Christopher Melrose
    email: Chris.Melrose@noaa.gov
    affiliation: NEFSCRI
  - name: Ryan E. Morse
    email: Ryan.Morse@noaa.gov
    affiliation: [IS,NEFSCRI]
  - name: Chris D. Orphanides
    email: Chris.Orphanides@noaa.gov
    affiliation: NEFSCRI
  - name: Charles T. Perretti
    email: Charles.Perretti@noaa.gov
    affiliation: [IS,NEFSCWH]
  - name: Vincent S. Saba
    email: Vincent.Saba@noaa.gov
    affiliation: NEFSCNJ
  - name: Laurel A. Smith
    email: Laurel.Smith@noaa.gov
    affiliation: NEFSCWH
  - name: John B. Walden
    email: John.Walden@noaa.gov
    affiliation: NEFSCWH
  - name: Harvey J. Walsh
    email: Harvey.Walsh@noaa.gov
    affiliation: NEFSCRI
  - name: Mark J. Wuenschel
    email: Mark.Wuenschel@noaa.gov
    affiliation: NEFSCWH
  - name: Donald M. Anderson
    email: danderson@whoi.edu
    affiliation: WHOI
  - name: Loren Kellogg
    email: Loren.Kellogg@noaa.gov
    affiliation: [IS,NEFSCWH]
  - name: Kristin M. Kleisner
    email: kristin.kleisner.work@gmail.com
    affiliation: EDF
  - name: Scott I. Large
    email: Scott.Large@noaa.gov
    affiliation: NEFSCWH
address:
  - code: NEFSCWH
    address: NOAA NMFS Northeast Fisheries Science Center, Woods Hole, MA, USA
  - code: IS
    address: Integrated Statistics, Woods Hole, MA, USA
  - code: NEFSCSS
    address: NOAA NMFS Northeast Fisheries Science Center, Silver Spring, MD, USA
  - code: NEFSCRI
    address: NOAA NMFS Northeast Fisheries Science Center, Narragansett, RI, USA
  - code: NEFSCNJ
    address: NOAA NMFS Northeast Fisheries Science Center, Geophysical Fluid Dynamics Laboratory, Princeton University, Princeton, NJ, USA
  - code: WHOI
    address: Woods Hole Oceanographic Institution, Woods Hole, MA, USA
  - code: EDF
    address: Environmental Defense Fund, Boston, MA, USA

date: '`r format(Sys.Date(), "%B %d, %Y")`'
abstract: |
  Understanding the context of ecosystem status and trends is important for making informed natural resource management decisions. However, many fishery management systems are fully occupied with decisions at the species or stock level, and busy managers are reluctant to consider extensive reports with unfamiliar information if the connections to current management decisions and objectives are unclear. Here, we describe the process used to develop streamlined ecosystem reporting to meet management needs in two US fishery management regions, New England and the Mid-Atlantic. A multi-disciplinary team was assembled to revise an initial report that had been based on a format used in another US region. First, ecosystem indicators were clearly aligned with stated fishery management objectives. Second, objectives and associated indicators relating to human well-being (e.g., seafood production) were placed first in the report, rather than last. Third, brief nontechnical text explained indicator relevance and connections between indicators, and standardized visualizations were used for time series and maps to streamline communication. Finally, reports used transparent and reproducible production methods to meet management deadlines. Engagement with managers is ongoing to further improve the utility of the report. This approach to streamlined, audience-specific ecosystem reporting is flexible and adaptable to many different governance contexts, and can be used to provide information essential to implement ecosystem based management.  
keywords: ecosystem approach, natural resource management, fisheries, integrated ecosystem assessment, ecosystem indicators, economic indicators, management objectives
bibliography: ["SOE.bib", "packages.bib"]
output: 
  bookdown::pdf_book:
    includes:
      in_header: riskassess-preamble-latex.tex
    base_format: rticles::plos_article
csl: plos.csl    
---

```{r Directory and Data Set-up, echo=F, message=F, warning=FALSE, paged.print=TRUE}

 data.dir  <- './data'
 image.dir <- './images'
 gis.dir <- './usa_shape_files'

#STOP HERE
#Do you have the most updated version of the SOE.data.2018 dataset AND the necessary spatial data? Check the SOE_MAB google drive for most recent version.


load(file.path(data.dir, "SOE_data_2018.Rdata"))
# latex figure folder
knitr::opts_chunk$set(echo = FALSE, fig.path = './iea_figs_ne/')

ERDDAP = FALSE  # change to TRUE to update the aggregate species list directly from ERRDAP, currently not working on NEFSC network

# automatically create a bib database for R packages
knitr::write_bib(c(
  .packages(), 'bookdown', 'knitr', 'rmarkdown'
), 'packages.bib')

#The map_figs option can be set to FALSE to skip making maps on the fly (they will be missing). Or TRUE to make them. 
map_figs <- T

```

```{r libraries, echo=F, message=F, warning=FALSE, paged.print=TRUE, results = 'hide'}
library(Kendall);library(data.table);library(zoo)
library(dplyr);library(nlme);library(AICcmodavg)
library(colorRamps);library(Hmisc);library(rgdal)
library(maps);library(mapdata);library(raster)
library(grid);library(stringr);library(png)
library(ncdf4);library(marmap); library(magick);
library(knitr); library(readr); library(kableExtra);
library(multipanelfigure); library(rerddap); library(tidyr)


#get map data and set constants
#projection
map.crs <- CRS("+proj=longlat +lat_1=35 +lat_2=45 +lat_0=40 +lon_0=-77 +x_0=0
               +y_0=0 +datum=NAD83 +no_defs +ellps=GRS80 +towgs84=0,0,0")

#coastline and bathymetry
coast <- readOGR(gis.dir, 'NES_LME_coast', verbose = F)
coast <- spTransform(coast,map.crs)
bathy <- raster('NES_bathymetry.tif')

#define extents for cropping
e  <- extent(-77.2, -64.2, 35, 48)
th_extent <-extent(-77,-65,35,45) #thermal habitat

#crop - thermal habitat bathymetry before general bathymetry
coast <- crop(coast, e)
th <- crop(bathy,th_extent)
bathy <- crop(bathy, e)

#projections
projection(th) <- map.crs
projection(bathy) <- map.crs

#get strata files to clip thermal habitat projections
strata <- readOGR(gis.dir,"strata", verbose = F)
strata@proj4string <- map.crs
```


```{r libraries and functions, include=F, echo = F}
options(repos = c(CRAN = "http://cran.rstudio.com"))


fit_lm <- function(dat) {
  # Remove missing values first so that all models
  # use the same number of observations (important for AIC)
  # dat <- dat %>% dplyr::filter(complete.cases(.))
  
  # Constant model (null model used to calculate 
  # overall p-value)
  constant_norm <-
    nlme::gls(series ~ 1, 
              data = dat)
  
  constant_ar1 <-
    try(nlme::gls(series ~ 1,
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(constant_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA)) 
  } 
  
  
  
  # Linear model with normal error
  linear_norm <- 
    nlme::gls(series ~ time, 
              data = dat)
  
  # Linear model with AR1 error
  linear_ar1 <- 
    try(nlme::gls(series ~ time, 
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(linear_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA))
    
  }
  
  # Polynomial model with normal error
  dat$time2 <- dat$time^2
  poly_norm <- 
    nlme::gls(series ~ time + time2, 
              data = dat)
  
  # Polynomial model with AR1 error
  poly_ar1 <- 
    try(nlme::gls(series ~ time + time2, 
                  data = dat,
                  correlation = nlme::corAR1(form = ~time)))
  if (class(poly_ar1) == "try-error"){
    return(best_lm <- data.frame(model = NA,
                                 aicc  = NA,
                                 coefs..Intercept = NA,
                                 coefs.time = NA,
                                 coefs.time2 = NA,
                                 pval = NA))
    
  }
  
  # Calculate AICs for all models
  df_aicc <-
    data.frame(model = c("poly_norm",
                         "poly_ar1",
                         "linear_norm",
                         "linear_ar1"),
               aicc  = c(AICc(poly_norm),
                         AICc(poly_ar1),
                         AICc(linear_norm),
                         AICc(linear_ar1)),
               coefs = rbind(coef(poly_norm),
                             coef(poly_ar1),
                             c(coef(linear_norm), NA),
                             c(coef(linear_ar1),  NA)),
               # Calculate overall signifiance (need to use
               # ML not REML for this)
               pval = c(anova(update(constant_norm, method = "ML"),
                              update(poly_norm, method = "ML"))$`p-value`[2],
                        anova(update(constant_ar1, method = "ML"),
                              update(poly_ar1, method = "ML"))$`p-value`[2],
                        anova(update(constant_norm, method = "ML"),
                              update(linear_norm, method = "ML"))$`p-value`[2],
                        anova(update(constant_ar1, method = "ML"),
                              update(linear_ar1, method = "ML"))$`p-value`[2]))
  
  best_lm <-
    df_aicc %>%
    dplyr::filter(aicc == min(aicc))
  
  
  if (best_lm$model == "poly_norm") {
    model <- poly_norm
  } else if (best_lm$model == "poly_ar1") {
    model <- poly_ar1
  } else if (best_lm$model == "linear_norm") {
    model <- linear_norm
  } else if (best_lm$model == "linear_ar1") {
    model <- linear_ar1
  }
  
  return(list(p = best_lm$pval,
              model = model))
}


#Plot new figure - Set end.start to 10 years before end of time series

soe.plot <- function(data, x.var, y.var, x.label = '', y.label = '', tol = 0.1,
                     x.start = NA, x.end = NA, end.start = 2008, bg.col = background, mean_line = T,
                     end.col = recent, stacked = NA, x.line = 2.5, y.line = 3.5, scale.axis = 1,
                     rel.y.num = 1.5, rel.y.text = 1.5, rel.x.text = 1, rel.x.num = 1,
                     suppressAxis = FALSE, status  = F, anomaly = F,
                     endshade = TRUE, full.trend = TRUE, point.cex = 1.5, lwd = 2, ymax = TRUE,ymin = TRUE,
                     y.upper = y.upper, y.lower = y.lower, extra = FALSE, x.var2 = x.var2, y.var2 = y.var2,
                     line.forward = FALSE, mean_line.2 = T, cex.stacked = 1) {
  
  #print("You'll need to remove or interpolate NA values before this function will work")
  
  #Select Data
  x <- data[Var == y.var, ]
  x <- x[order(x[, get(x.var)]), ]
  setnames(x, x.var, 'X')
  
  #Set common time step if necessary
  if(is.na(x.start)) x.start <- min(x[, X])
  if(is.na(x.end))   x.end   <- max(x[, X])
  x <- x[X >= x.start, ]
  
  #Set up plot parameters
  if (ymax == TRUE){
    y.max <- max(x[, Value]) + tol * max(x[, Value])
  } else {
    y.max <- as.numeric(y.upper)
  }
  
  if (ymin == TRUE){
    y.min <- min(x[, Value]) - tol * abs(min(x[, Value]))
  } else if (ymin == FALSE){
    y.min <- as.numeric(y.lower)
  }
  
  y.mean <- mean(x[, Value])
  y.sd <- sd(x[, Value])
  
  #Plot blank plot
  plot(x[X >= x.start, list(X, Var)], xlim = c(x.start, x.end),
       ylim = c(y.min,y.max), xlab = '', ylab = '', axes = F, ty = 'n')


  #Add background
  u <- par('usr')
  rect(u[1], u[3], u[2], u[4], border = NA, col = bg.col)
  
  #Add end period shading
  if (endshade == TRUE){
    rect(end.start - 0.5, u[3], u[2], u[4], border = NA, col = end.col)
  }
  
  #Add mean line
  if (anomaly == F){
      if (mean_line == TRUE){
      abline(h = y.mean, col = 'grey', lwd = 3, lty = 2)
      } 
  } else if (anomaly == TRUE){
      abline(h = 0, col = 'grey', lwd = 3, lty = 2)
  }
  
  #Add x y lines
  abline(h = u[3], lwd=3)
  abline(v = u[1], lwd=3)
  
  #Add data points/lines
  points(x[, list(X, Value)], pch = 16, cex = point.cex)
  lines( x[, list(X, Value)], lwd = lwd)
  
  #extra lines
  if (extra == TRUE){
    x2 <- data[Var == y.var2, ]
    x2 <- x2[order(x2[, get(x.var2)]), ]
    setnames(x2, x.var2, 'X2')
    x2 <- x2[X2 >= x.start, ]
    if (mean_line.2 == TRUE){
     abline(h = mean(x2[, Value]), col = 'lightcoral', lwd = 3, lty = 2) 
    }
    points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
    lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
    }
    
  
  #Add axis
  if (suppressAxis == FALSE){
    if(is.na(stacked)) axis(1, cex.axis = rel.x.num) # SKG changed from default of 1, put rel.x.num=1 as default in function call
    if(!is.na(stacked)){
      if(stacked!= 'A') axis(3, cex.axis = 1.5, tck = 0.1, labels = F)
    }
  }

  #Stacked axes with 0 overlap so need to remove
  labels <- round((axTicks(2) / scale.axis), 5)
  if(labels[1] == 0) labels[1] <- ''
  axis(2, at = axTicks(2), labels = labels, cex.axis = rel.y.num,
       las = T)

    #Add axis labels
    if(!is.na(stacked)) text(u[1], u[4], labels = stacked, cex = cex.stacked, adj = c(-0.5, 1.5))
    if(is.na(stacked)){
      mtext(1, text = x.label, line = x.line, cex = rel.x.text) #SKG changed from hardcoded cex = 1 for x axis, added default of 1 in function call
      mtext(2, text = y.label, line = y.line, cex = rel.y.text)
    }
  
    if (full.trend == T){
    #Split data into past decade and full time series
    dat <- as.data.frame(x[, list(X, Value)])
    
    dat <- dat %>% dplyr::rename(series = Value) %>%
      mutate(time = seq(1,nrow(dat),1))
    
    # Fit linear model
    lm_out <- fit_lm(dat = dat)
    p <- lm_out$p
    if (p < .05){
        
      newtime <- seq(min(dat$time), max(dat$time), length.out=length(dat$time))
      newdata <- data.frame(time = newtime,
                      time2 = newtime^2)
      lm_pred <- AICcmodavg::predictSE(lm_out$model, 
                                 newdata = newdata,
                                 se.fit = TRUE)
      
      year <- seq(x$X[1],x$X[length(x$X)],length.out = length(dat$time))

      # Make plot
      if (lm_pred$fit[length(lm_pred$fit)] > lm_pred$fit[1]){
        lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex)
        lines( x[, list(X, Value)], lwd = lwd)

        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.pos, lwd = 7)
        }
      } else if (lm_pred$fit[length(lm_pred$fit)] < lm_pred$fit[1]){
        lines(year, lm_pred$fit, col = main.neg, lwd = 7)
        points(x[, list(X, Value)], pch = 16, cex = point.cex)
        lines( x[, list(X, Value)], lwd = lwd)
        if (line.forward == TRUE){
           lines(year, lm_pred$fit, col = main.neg, lwd = 7)
        }
      }
    }
    
    if (extra == TRUE){
      
      # Second variable
      dat <- as.data.frame(x2[, list(X2, Value)])
    
      dat <- dat %>% dplyr::rename(series = Value) %>%
      mutate(time = seq(1,nrow(dat),1))
    
     # Fit linear model
      lm_out <- fit_lm(dat = dat)
      p <- lm_out$p
      points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
      lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
      if (p < .05){
    
        newtime <- seq(min(dat$time), max(dat$time), length.out=length(dat$time))
        newdata <- data.frame(time = newtime,
                      time2 = newtime^2)
        lm_pred <- AICcmodavg::predictSE(lm_out$model, 
                                 newdata = newdata,
                                 se.fit = TRUE)
        
        year <- seq(x2$X2[1],x2$X2[length(x2$X2)],length.out =length(dat$time))
   
    # Make plot
        if (lm_pred$fit[length(lm_pred$fit)] > lm_pred$fit[1] ){
          lines(year, lm_pred$fit, col = main.pos, lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        } else if (lm_pred$fit[length(lm_pred$fit)] < lm_pred$fit[1]){
          lines(year, lm_pred$fit, col = main.neg, lwd = 7)
          points(x2[, list(X2, Value)], pch = 16, cex = point.cex, col = "indianred")
          lines( x2[, list(X2, Value)], lwd = lwd, col = "indianred")
        } 
     }
    }

  }


 
}  


#Add axis labels for stacked plots
soe.stacked.axis <- function(x.label, y.label, x.line = 2.5,rel.x.text = 1.5,
                             y.line = 3.5, rel.y.text = 1.5, outer = TRUE){
  axis(1, cex.axis = rel.x.text)
  mtext(1, text = x.label, line = x.line, cex = rel.x.text, outer = outer)
  mtext(2, text = y.label, line = y.line, cex = rel.y.text, outer = outer)
  
}


#Background colors
background   <- 'white'
recent       <- '#E6E6E6'
main.pos <- rgb(253/255, 184/255, 99/255,  alpha = .9)
main.neg <- rgb(178/255, 171/255, 210/255, alpha = .9)

#Finder function for quickly finding variables based on partial match
finder <- function(data, match = match, factor = T){
  found <- unique(data[grepl(match,data$Var),]$Var)
  if (factor == T){
    return(found)
  } else {
    return(as.character(found))
  }
  
}

#thermal habitat map function
#thermal habitat map function
th_plot <- function(data, letter, z.max, y.axis = T,
                    legend = T, pos){
  if (pos == 'topleft'){
    par(mar=c(3.9, 2.8,3.5,0), mex = .3,  mgp = c(4, .35, 0))
  } else if (pos == 'topright'){
    par(mar=c(3.9, 0, 3.5, 2.8), mex = .3,  mgp = c(4, .35, 0))
  } else if (pos == "bottomleft"){
    par(mar=c(3.9,2.8,3.5,0), mex = .3,  mgp = c(4, .35, 0))
  } else if (pos == "bottomright"){
    par(mar=c(3.9, 0, 3.5, 2.8), mex = .3,  mgp = c(4, .35, 0))
  }
  
  data <- nc_open(data)
  
  #longitude
  lon <- ncvar_get(data, "xi", verbose = F)
  
  #latitude
  lat <- ncvar_get(data, "yi", verbose = F)
  
  #thermal habitat projection
  z <- ncvar_get(data, "zi")
  
  #combine in data.frame
  proj <- data.frame(lon = lon,
                     lat = lat,
                     z = z)
  
  proj <- proj %>% filter(z != "NA",z>0) %>% 
    mutate(z = plyr::mapvalues(z, from = (z[(z>z.max)]), to = rep(z.max,length(z[(z>z.max)]))))
  
  #turn dataframe to raster
  coordinates(proj) = ~lon+lat
  proj4string(proj)=map.crs # set it to lat-long
  proj = spTransform(proj,map.crs)
  proj <- proj[strata,]
  gridded(proj) = TRUE
  r = raster(proj)
  projection(r) = map.crs
  
  colors <- matlab.like(120)
  #plot maps
  if (legend == T){
    plot(r, col=colors, ylim=c(35,45),
         breaks=seq(0,z.max,length.out=length(colors)),
         zlim = c(0,z.max),
         legend.width = 2,
         axes=F, interpolate = T, las = 1,box = T,
         axis.args=list(at=seq(0, z.max, length.out = 5),
                        labels=round(seq(0,1,length.out = 5),1), 
                        cex.axis=0.8),
         legend.args=list(text=expression(paste("     Thermal \n      Habitat")),
                          side=3, font=2, line=1, cex=.65))
  } else {
    plot(r, col=colors, ylim=c(35,45),
         breaks=seq(0,z.max,length.out=length(colors)),
         axes=F, interpolate = F, las = 1,box = T,legend = F)
  }
  
  
  map("worldHires", xlim=c(-77,-65),ylim=c(35,45), fill=T,border=0,col="gray", add = T)
  
  if (y.axis == T){
    map.axes(cex.axis = .7)
  } else if (y.axis == F){
    axis(1,cex = .7)
    box(lty = 'solid', col = 'black',lwd = 1)
  }
  
  
  contour(th,drawlabels = F,nlevels = 2,add=T, col = "gray20",lty=2, lwd = .5)
  text(-75.5, 43.9, letter,cex = 1.5)
  
}


```


# Introduction
As national and international policy increasingly calls for ecosystem-based management of natural resources [e.g., @sherman_global_2005; @heenan_climate-informed_2015; @ramirez-monsalve_ecosystem_2016; @smith_implementing_2017], it is important for decision-makers to understand the current status and recent trends of key ecosystem attributes. For example, an ecosystem in a high productivity state may be more resilient and withstand extractive activities better than the same ecosystem in a low productivity state; and climate change may alter the productivity of an ecosystem [@brander_global_2007; @blanchard_potential_2012; @friedland_pathways_2012; @stock_reconciling_2017]. Information on ecosystem productivity has proven useful in management of economically important marine fisheries in Alaska, USA [@zador_ecosystem_2016], where the management system has embraced many aspects of the ecosystem approach [@witherell_ecosystem-based_2000; @livingston_framework_2005]. In addition to productivity, changes in the spatial and functional structure of ecosystems can have profound impacts on managed populations and ecological communities, requiring adjustments in natural resource management [@doney_climate_2012]. Therefore, ecosystem status and trends provide critical context for operational natural resource management, even if management objectives are defined at the resource population level. Further, there has been considerable scholarship on the development, testing, and use of ecosystem indicators in operational fishery management [@degnbol_review_2004; @jennings_indicators_2005; @rice_framework_2005; @rochet_explicit_2005; @link_translating_2005; @samhouri_quantitative_2009; @large_defining_2013; @fay_testing_2013; @large_quantifying_2015; @fay_management_2015; @otto_quantitative_2017; @tam_towards_2017; @shin_specificity_2018]. Ecosystem reporting has also progressed such that ecosystem information is more commonly available [e.g. @noauthor_ecosystem_nodate-1; @noauthor_ecosystem_nodate].   

Why, then, is it still relatively rare to see information on ecosystem status and trends routinely considered in fishery management? Myths regarding implementation of ecosystem based management are largely resolved, and practical examples of management incorporating ecosystem information and tools exist [@smith_scientific_2007; @patrick_myths_2015; @smith_implementing_2017]. There are quantitative and qualitative routes for ecosystem information to enter the fishery management system: directly within analyses aimed at providing population or stock-level harvest advice (stock assessments), within analyses aimed at providing habitat, multispecies, or ecosystem-level advice, or to provide context for qualitative decisions. Direct consideration of ecosystem factors has been limited within fishery stock assessments to date [@skern-mauritzen_ecosystem_2016], although indirect consideration of ecosystem factors at the population level happens more often [@marshall_inclusion_2018]. Multiple levels are necessary: considering only stock level advice leads to potentially counterproductive management if stock interactions are not considered, while considering only system level advice misses how stocks are differentially targeted by fisheries and respond differently to common environmental signals [@fogarty_art_2013]. Most fishery management systems are set up to consider stock level advice, but few have established processes to consider stock interaction or system level advice [@dereynier_bringing_2010; @gaichas_framework_2016]. Therefore, some lack of consideration may come from lack of process, while other reasons may include disconnects between the information provided and the information needs of managers. 

For example, there is clear interest in integrating ecosystem considerations within fishery management in the Northeast US [@biedron_toward_2016], and recent adoption of an ecosystem policy statement by one of the two Federal fishery management bodies [@seagraves_mid-atlantic_2016]. Ecosystem Status Reports [@program_ecosystem_2012] have been produced for the Northeast US since 2009. Despite this interest and availability of ecosystem information, when presented with a draft "State of the Ecosystem" report for the Northeast US formatted like one from the US West Coast [@noauthor_annual_nodate], managers and scientific reviewers alike asked "So what?" Fishery managers are faced with many issues, with overfull meeting agendas and briefing books containing hundreds of pages of material. While potentially interesting, managers needed to understand why ecosystem status and trends are relevant, given all of the other pressing issues they face. It is therefore important that providers of ecosystem information clearly link ecosystem indicators to management objectives [@degnbol_review_2004].

Our objective was to develop streamlined, relevant ecosystem reporting tailored to a specific audience: fishery managers. Efficiency is key, because two similar yet separate reports are generated for the two regional management bodies annually: the New England Fishery Management Council (NEFMC) and the Mid-Atlantic Fishery Management Council (MAFMC). Additional reporting for an interstate management commission is possible in the future. In this paper, we outline our process and key components of our revised reporting that efficiently and transparently deliver relevant ecosystem information to both regional Councils; our lessons learned can readily apply to other ecosystem reporting efforts.

# Methods
Priorites for ecosystem reporting included clear communication of relevance to management, synthesis of messages across indicators, and efficiency of production, delivery, and use by managers. Methods applied to achieve each priority are described in sections below.

## Priority: Clear communication of relevance to management
Our initial step was to clearly align indicators with management objectives. This is required to conduct integrated ecosystem assessment [@levin_integrated_2009, @levin_guidance_2014], and has been advised many times in the literature [@degnbol_review_2004; @jennings_indicators_2005; @rice_framework_2005; @link_translating_2005]. A difficulty with pratical implementation of this in ecosystem reporting can be the lack of clearly specified ecosystem-level management objectives (although some have been suggested [@murawski_definitions_2000]). In our case, considerable effort had already been applied to derive both general goals and operational objectives from both US legislation such as the Magnuson-Stevens Fisheries Conservation and Management Act (MSA) and regional sources [@depiper_operationalizing_2017]. While we realized that this list of objectives remained somewhat general and would need refinement together with managers and stakeholders in our region, it served as a useful starting point to structure ecosystem reporting.

A second critical structuring element for ecosystem reporting was a conceptual model linking environmental drivers, ecosystem components, human activities, and the management objectives [@pavao-zuckerman_conceptual_2000; @heemskerk_conceptual_2003]. Conceptual models summarize the "big picture" of relationships of interest to managers, including factors both within and outside their control that affect the ability to achieve objectives. Several excellent examples of conceptual models were developed for integrated ecosystem assessment in the California Current [@levin_conceptualization_2016; @breslow_conceptualizing_2016], which we used as initial templates. Conceptual models for the Northeast US were developed as part of the scientific investigation of best practices for implementing integrated ecosystem assessment [@depiper_operationalizing_2017].  Methods and sources for constructing the Northeast US conceptual models are detailed in the [first section of Supporting Information S1](https://noaa-edab.github.io/tech-memo/conceptual-models.html). 

A final simple step for improving relevance for fishery managers was to reverse the typical order that indicators had been presented in past reporting. Instead of starting with climate drivers and physical ecosystem processes, we placed human dimensions (e.g., food production, fishery economics, human community) indicators first. This does not imply that climate drivers are any less important, but rather responds to documented management needs: "one of the greatest perceived needs for decision-maker and stakeholder adoption of EBFM in the MAFMC and NEFMC is more information about human dimensions, including economics, jobs, revenue, and communities [@biedron_toward_2016]." In addition, placing human dimensions first provides a starting point to address the need to document relationships between human well-being and ecosystem services within the region [@ruckelshaus_notes_2015].

## Priority: Synthesis across indicators
Individual indicators are necessarily linked to individual ecosystem attributes and or management objectives, but at the ecosystem level there are multiple objectives and tradeoffs for managers to weigh [@link_ecosystem-based_2010]. It is also clear that multiple indicators are required to understand the interactions of the many ecosystem factors that affect outcomes for management, whether they are reported separately or integrated within a formal analytical framework [@samhouri_quantitative_2009; @van_oudenhoven_framework_2012; @large_quantifying_2015; @zador_ecosystem_2016]. Regional managers requested improved synthesis across indicators during initial review. We both structured the report and modified our report production approach to provide improved indicator synthesis relevant to fishery managers.

The simple structural approach was to include a short lead synthesis section in the report. This "executive summary" aimed to summarize across all objectives and associated indicators in the first 2-3 pages of the report, highlighting key messages similar to "report cards" produced in other regions [@zador_ecosystem_2016]. The purpose of the summary is to link indicator trends where possible between human dimensions, managed species, and ecological/environmental drivers.

To achieve the goal of succinct synthesis, the report production process was changed. Due to resource limitations, initial reports (2015-2016) were developed by a single scientist from existing indicators [@program_ecosystem_2012, @nefsc_northeast_2015] with requests for updated data from multiple contributors. This process made synthesis difficult, and underutilized the knowledge and experience of contributors. A team of 3 leads worked on the 2017 report, which improved report structure, but synthesis remained difficult. Planning for the 2018 reports began in August 2017 with a workshop to develop a new report outline. Participants in the workshop included scientists (anthropologists, economists, physical and biological oceanographers, habitat specialists, food web ecologists, population biologists, protected species experts, and modelers) along with fishery managers. These diverse experts discussed the report outline as a full group but also self-organized into smaller interim working groups (human dimensions, protected species, resource species, habitat, and ecosystem productivity) to develop new indicator suites within the report sections. Data contributions were requested in December 2017, earlier than in previous years. A synthesis workshop with the full group was held in Mid-January 2018 to review subgroup results and  begin to develop synthesis within and across report sections. The full report was produced, internally reviewed, and revised during February 2018, with initial review by the MAFMC's Scientific and Statistical Committee (SSC), in early March 2018. (Each U.S. fishery management Council has its own SSC to provide scientific advice for management.) Based on this initial scientific review, the report was revised again (including a section with Council/SSC comments and responses). During revision, experts were called on as necessary to respond to comments from each Council. 

## Priority: Efficient production for multiple management jurisdictions
To provide reports within each Council's management timeframes, the process described above also needed to be efficient. To achieve this, we first built on existing efforts inside and outside the region, including the previously published comprehensive Northeast US Ecosystem Status Reports (ESRs, [@program_ecosystem_2012, @nefsc_northeast_2015]), management and economic performance reports [@clay_measuring_2014], and social indicators [@colburn_social_2012; @jepson_development_2013; @colburn_indicators_2016]; the US California Current State of the Ecosystem (SOE) report [@noauthor_annual_nodate], which served as our initial report template; and the US Alaska annual Ecosystem Considerations report [@zador_ecosystem_2016]. The experience with gathering, documenting, and visualizing indicators across all of these reports was critical to efficient development of our fishery management Council-targeted SOE report.

A structuring element of previous Northeast US ecosystem reporting was geographic subdivision of the Northeast US shelf into Ecosystem Production Units (EPUs) based on production characteristics. These units were maintained in reporting to Councils to emphasize a place-based ecosystem approach [@fogarty_art_2013]. Methods and sources for describing the EPUs are detailed in the [fourth section of Supporting Information S1](https://noaa-edab.github.io/tech-memo/epu.html). 

Many aspects of efficient reporting followed the California Current's example [@noauthor_annual_nodate], including limiting report length to fewer than 25 printed pages, using non-technical language, and including indicator data in a standardized format with standardized plotting throughout the report. In addition, we included a specific response to SSC and previous Council comments section, as noted above, to track progress on Council requests.

While technical descriptions and scientific references were not included in the report, both to streamline communication and to remain within the page limit, full documentation of indicators and underlying methods was provided in another document, similar to the California Current report. Similarly, we published our technical methods separately online (see [Supporting Information S1](https://noaa-edab.github.io/tech-memo/)). This is intended to allow more streamlined version control and updating for future SOE reports. 

We produced the SOE report in R Markdown [@R-rmarkdown] for reproducibility and ease of developing two similarly structured reports with different data sources for the two regional Councils. Report source documents for the 2017 and 2018 reports were version controlled in a private GitHub repository (due to concerns with data confidentiality). Code producing figures were posted, along with the details of data sources, extraction, and analysis in the online SOE technical methods ( [Supporting Information S1](https://noaa-edab.github.io/tech-memo/)). Each indicator is described using an individual R Markdown document, with all indicator source documents rolled up into one bookdown [@R-bookdown] and published using GitHub pages.

Final State of the Ecosystem reports were presented to the full Councils at their respective April meetings in 2018. Councils received their reports as both a pdf report in advance of the meeting, and as an in-person presentation during the meeting. Reporting focuses on whether there are big changes in the ecosystem or other threats to achieving Council management objectives. The in-person presentation also provides an opportunity for Council discussion of further information that can be provided to enhance decision-making. 

# Results
The results of this process, the full [Mid-Atlantic State of the Ecosystem 2018](http://www.mafmc.org/s/Tab04_State-of-the-Ecosystem-Apr2018.pdf) and
[New England State of the Ecosystem 2018](https://s3.amazonaws.com/nefmc.org/2_Ecosystem-Status-Report.pdf), were finalized in April 2018. These reports are now posted as part of the public record on each of the respective Council's websites (See Supporting Information S2 and S3). We excerpt portions from each report (italicized in blocks below, minimally edited for clarity) to illustrate how the key priorities outlined above were addressed. Clear communication of relevance to management was established in the opening pages of each report, using a conceptual model and an overview of objectives linked to indicators. This executive summary also emphasized synthesis of the messages across all indicators in the report. In the main body of the report, details are provided in support of the executive summary. Placing human dimensions objectives and indicators first in the report further emphasized the report's relevance to managers. We illustrate this by reproducing the first indicator and comparing presentation across the two reports. Finally, we illustrate further synthesis across individual indicators using the Mid-Atlantic report section on ecosystem productivity. Section titles below reflect priorities and the purpose of each report section.

## Priority: Clear communication of relevance to management
The executive summary outlines the report purpose, structure, alignment with management objectives, and synthetic results in 2-3 pages. Here, we highlight key aspects and findings of the reports that arose from the multidisciplinary approach. We excerpt most sections from the leading pages of the Mid-Atlantic report as an example below, demonstrating the use of conceptual models, place-based spatial units, and alignment of ecosystem indicators with management objectives as noted in each subsection header. Exceprts from the reports are block indented and italicised below, but appeared in normal font in the actual report, with key report messages highlighted in **boldface**. Tables exerpted directly from the reports are block indented, except where noted below. Figure captions have been expanded for this paper (and are not italicized), and some separate report figures have been consolidated into multipanel figures for this paper. 

### Purpose: Mid-Atlantic SOE Report Introduction
>*The purpose of this report is to provide **ecosystem-scale information for fishery managers** to consider along with existing species-scale analyses.  An overview of ecosystem relationships as represented by **a conceptual model helps place more detailed species-level management in context** by highlighting relationships between focal species groups organized by Mid-Atlantic Fishery Management Council (MAFMC) Fishery Management Plan (FMP), managed human activities, environmental drivers, habitats, and key ecological links (Fig \@ref(fig:conceptual)). Here, human activities link to high level strategic management objectives. Many components of the conceptual model are represented by indicators in this report, and key paths connecting components and objectives are highlighted.*

>**Fig \@ref(fig:conceptual). Overview of ecosystem relationships for the Mid-Atlantic Ecosystem.**  Human activities link to high level strategic management objectives (MAFMC FMP). Components are represented by indicators in this report, and key paths connecting components and objectives are highlighted.

### Structure with management objectives: Mid-Atlantic SOE Report Executive Summary
>*We have organized this report using a proposed set of **ecosystem-scale objectives** derived from US legislation and current management practices (Table \@ref(tab:objcatsMAB)). We report indicators at the spatial scale of either the Mid-Atlantic Bight (MAB; Fig \@ref(fig:map)), for Mid-Atlantic states, or Northeast US coastwide where appropriate. Indicator spatial scale is noted in each section heading.* 

```{r objcatsMAB, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
tabl <- "
|Objective Categories|Indicators Reported Here|
|:--------------------|:----------------------------------------------|
| Seafood production  | Landings by feeding guild, mariculture        |
| Profits             | Revenue by feeding guild                      |
| Recreation          | Number of anglers and trips; recreational catch|
| Stability           | Diversity indices (fishery and species)        |
| Social-Cultural     | Commercial and recreational reliance; social vulnerability|
| Biomass             | Biomass or abundance by feeding guild from surveys |
| Productivity        | Condition and recruitment of MAFMC managed species |
| Trophic structure   | Relative biomass of feeding guilds, primary productivity  |
| Habitat             | Thermal habitat projections, estimated habitat occurrence |"
  #cat(tabl) # output the table in a format good for HTML/PDF/docx conversion

  df<-read_delim(tabl, delim="|")
  df<-df[-c(1,2) ,c("Objective Categories","Indicators Reported Here")]
  knitr::kable(
    df, booktabs = TRUE,
    caption = 'Ecosystem-level management objectives.'
  ) %>%
    kable_styling(font_size =8, latex_options=c("hold_position", "right")) 
```

>**Fig \@ref(fig:map). Mid-Atlantic Bight (MAB) spatial extent.** Geographic units for Georges Bank (GB) and Gulf of Maine (GOM) are also indicated.

### Synthesis of single species status in executive summary
>**_We also report single-species status relative to established objectives and reference points_**. *The Mid-Atlantic Council (MAFMC) is meeting objectives at the managed species (stockwide) level for fishing mortality (F) rates for 8 of 15 stocks and biomass (B) levels for 11 of 15 stocks relative to established reference points (Fig \@ref(fig:KOBE)). The exceptions include high F rates for summer flounder and Atlantic mackerel, low B status for Atlantic mackerel, and likely high F rates for blueline tilefish. Three stocks (Illex squid, Northern and Southern monkfish) have unknown status for both F and B, blueline tilefish for B, and longfin squid have unknown F status.*

>**Fig \@ref(fig:KOBE). Summary of single species status for Mid-Atlantic Fishery Management Council (MAFMC) and jointly managed (Joint) stocks.** Dashed lines indicate thresholds for fishing mortality rate relative to the limit (F/Fmsy = 1) and for biomass relative to the minimum (B/Bmsy=0.5). The dotted line indicates the biomass target (B/Bmsy = 1). Status is based on the most recent published stock assessment or linked assessment update for each stock (2017 unless otherwise noted): Mackerel [@nefsc_64th_2018], 2016 Fluke ( [summer flounder](http://www.mafmc.org/s/Summer_flounder_2015_Assess_Update.pdf)), [Dogfish](http://www.mafmc.org/s/2017-Status-Report-for-spiny-dogfish.pdf), [Tilefish](http://www.mafmc.org/s/Golden_Tile_Assessment_Update2017-POPDY.pdf), 2015 Bluefish [@nefsc_60th_2015], [Butterfish](http://www.mafmc.org/s/Butterfish-2017-Stock-Assessment-Update.pdf), Ocean quahog [@nefsc_63rd_2017], [Scup](http://www.mafmc.org/s/5Scup_2017_Assesssment_Update.pdf), Black sea bass [@nefsc_62nd_2017], Surfclam [@nefsc_61st_2017], [Longfin squid](http://www.mafmc.org/s/Doryteuthis_update_April_2017.pdf), [Illex squid](http://www.mafmc.org/s/Illex-illecebrosus_data_update_report_for_2017_MAFMC_SSC_ABC.pdf), Northern and Southern Monkfish [@richards_2016_2016].

## Priority: Synthesis across ecosystem indicators in executive summary
>**_Performance against human dimensions objectives is mixed, with declines in seafood production and recreational opportunities but stabilization of fleet numbers and revenue diversity._**  *Revenue has seen substantial interannual variability in recent years, driven primarily by increases in prices of benthos (i.e. scallops & clams). Total volume of landings have decreased since at least 2010, with seafood production by both commercial and recreational fisheries declining overall. This corresponds to a stark decrease in recreational fishing effort and participation since 2008, although the number of commercial fleets, and the diversity of revenue generated from those fleets, have been relatively stable in the last few years. The diversity of species revenue, measured at the individual permit level, has also been relatively stable over the past 10 years. However, many communities in the Mid-Atlantic Bight (MAB) that are highly engaged and/or reliant on commercial fishing are socially vulnerable, and **5 of the 6 largest commercial fishing ports in the MAB (in terms of revenue) are heavily dependent on benthic species which are in turn highly vulnerable to climate change (Fig \@ref(fig:sppvul)).** *

>**Fig \@ref(fig:sppvul). Climate-vulnerable fisheries landings in key Mid-Atlantic fishing ports.**

>**_Fisheries are currently meeting objectives with respect to bycatch reduction for some protected species, but climate and ecosystem changes may upset this balance._** *Fisheries interactions with harbor porpoise have decreased due to management measures, but climate driven distribution changes for sea turtles may lead to future fishery interactions and potential regulations. In addition, the most endangered species in the system (North Atlantic right whale) has been in decline since 2010, after a slow, erratic increase in abundance in the two previous decades. The decline is due primarily to entanglement in fishing gear and vessel strikes. Even when North Atlantic right whales were increasing, their recovery was jeopardized by chronically high levels of anthropogenic mortality.  Recently, as right whale prey (Calanus) distribution has changed, right whales have changed their distribution as well, putting at least some whales into an area with a high density of fishing gear that is particularly dangerous for them.*

>**_Biomass of resource species changes seasonally in this dynamic system._**  *Survey biomass trends for aggregated trophic groups of resource species differ in the fall and spring. Larval survey data indicates species diversity has increased in the spring, but no similar shift has been witnessed in the fall. At the lowest trophic level, benthos, including commercial shellfish, show long term increases in both seasons. In contrast, piscivores at higher trophic levels have conflicting long term trends depending on the season sampled. Seasonally divergent aggregate trends require further investigation.*

>**_Additional indicators in this report suggest a note of caution for the aggregate productivity of fish species in the region_** *(fish condition declined and recovered for some species while survey based aggregate “recruitment” has declined overall). These changes in fish productivity may be linked to observed patterns in plankton communities, to changes in habitat, or both.  While there are some long-term productivity trends at the bottom of the food web in the Mid-Atlantic, changes in species composition and shifts in seasonal timing may have a greater impact on upper trophic levels. Temperature is increasing in long term sea surface records as well as surface and bottom measurements from surveys. The seasonal temperature signal also shows sustained warming. **Warming waters have impacts on the ecosystem that can be complex due to differential impacts at the species level, including observed shifts in species distribution and changes in productivity as thermal habitats shift.** *

### Changes to reporting from the previous year, orientation to standard plots
>
*Indicators throughout the report have been updated with the most recent data, and in some cases replaced with more management-relevant indicators based on Council feedback from the 2017 report. In particular, new sections on species-specific habitat status and trends and climate projections of thermal habitat for key species have replaced last year’s more general physical environment and climate sections. This report draws on a wider range of expertise and attempts to further link information across indicators to give an integrated overview of ecosystem status relevant to fishery management decision making.*
>
*Many metrics aggregate species by similar functional groups.  Species that comprise the functional groups are listed below. Relative to the 2017 report, these categories have been aggregated into fewer groups for simplification and clarity (Table \@ref(tab:speciesgroupingsMAB)*, generalized for this paper).
 
```{r speciesgroupingsMAB, echo=FALSE, message=FALSE, warning=FALSE}
# tabl <- "
# |Group|N species|Major species in the group|
# |:------------------|:-------|:--------------------------------------------|
# | A: **Apex predator** (Highest trophic level)   |  4  | shark (Unc.), swordfish, yellowfin and bluefin tuna |
# | B: **Piscivore** (Eat fish)                    |  23 | spiny dogfish, summer flounder, bluefish, striped bass, weakfish, monkfish, winter and thorny skates, silver and offshore hake, Atlantic cod and halibut, fourspot flounder |
# | C: **Planktivore** (Eat plankton)              |  16 | Atlantic and blueback herring, alewife, shad, menhaden, cusk, Atlantic mackerel, butterfish, blackbelly rosefish, sculpins, lumpfish, northern searobin, northern sand lance, northern shortfin and longfin squid |
# | D: **Benthivore** (Eat bottom dwellers)       |  25 | black sea bass, scup, tilefish, tautog, cunner, blue crab, red crab, lobster, ocean pout, haddock, yellowtail, winter, and witch flounders, barndoor skate, American plaice, other crabs|
# | E: **Benthos**  (Filter feeders)               |  9  |  scallops, surfclam, quahog, mussels, whelks, conchs, sand dollars and urchins |
# "
# #cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
# df<-read_delim(tabl, delim="|")
# df<-df[-c(1,2) ,c("Group","N species", "Major species in the group")]

#read the table from ERDDAP instead and format to clarify which species are managed by whom
if(ERDDAP){
  #Identify the ERDDAP server where data are stored
  comet <- 'http://comet.nefsc.noaa.gov/erddap/'
  df <- tabledap('species_groupings_V2', url = comet,
                 fields = c('SOE_18', 'COMNAME', 'Fed_Managed')) 
  #'SOE_18!="Other"', distinct = TRUE) doesn't work, do next
  write_csv(df, file.path(data.dir, "aggsp.csv"))
}
df <- read_csv(file.path(data.dir, "aggsp.csv") , col_names = TRUE) %>%
  filter(SOE_18 != "Other") %>%
  distinct() %>%
  group_by(SOE_18, Fed_Managed) %>%
  summarize_all(funs(paste(na.omit(.), collapse = ", "))) %>%
  spread(Fed_Managed, COMNAME) %>%
  arrange(factor(SOE_18, levels = c("Apex Predator", "Piscivore", "Planktivore", "Benthivore", "Benthos")))
df<-df[,c(1,3,2,4,5)] %>%
  mutate_all(tolower)


knitr::kable(df, booktabs = TRUE, caption = 'Feeding guilds and management bodies.', 
             col.names = c("Guild", "MAFMC", "Joint", "NEFMC", "State or Other")) %>%
  kable_styling(font_size=10, latex_options=c("repeat_header", "scale_down", "hold_position")) %>%
  column_spec(1, width="2cm") %>%
  column_spec(2, width="5cm") %>%
  column_spec(3, width="2cm") %>%
  column_spec(4:5, width="5cm") %>%
  #column_spec(3, width="7.5cm") #%>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle")

```

>
*Our assessment of indicator trends has changed this year.  In the 2017 time series plots, monotonic (but not necessarily linear) trends were assessed for both the full time series and the most recent 10 years (shaded dark grey background). Recent simulation analysis suggest that statistical significance tests are unreliable for short time series, but reliable for longer ones. Therefore, similar to 2017, we indicate significant increasing long term trends with orange lines, while significant decreasing long term trends have purple lines.  However, we no longer indicate significant trends for the most recent period but rather discuss recent/current status and trend of each indicator relative to the full time series.  Time series mean is indicated with a dashed line and the final ten years of the time series are highlighted through a grey background.* 

## Priority: Efficient production for multiple management jurisdictions
The main body of each report follows the executive summary with more detail on the indicator results specific to each region, but using the same structure and analytical methods. The full report includes indicators of fishery performance, human community vulnerability, fishery interactions with protected species, resource species trends, and ecosystem conditions and productivity (Table \@ref(tab:SOEcontents)). Time series plots throughout the report use the standardized approach described in the executive summary to allow quick visual identification of significant trends, and qualitative observations within the most recent 10 years. 

```{r SOEcontents, echo=FALSE, message=FALSE, warning=FALSE}

SOEcont <- read.csv(file.path(data.dir,"indicatortable.csv"))
knitr::kable(SOEcont, format = "latex", booktabs = T, caption = 'Report sections, indicators, and scale of information.') %>%
  kable_styling(font_size=10, latex_options=c("repeat_header", "scale_down", "hold_position")) %>%
  column_spec(1, width="3cm") %>%
  column_spec(2:3, width="7cm") %>%
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle")

```

Below we give two examples of SOE reporting from the main body of the report illustrating the priorities for addressing "so what." In the first, we demonstrate how reporting of the same indicator suite was tailored for a single ecological production unit (Mid-Atlantic) and for two ecological production units within one management jurisdiction (New England). This was the first in-depth indicator discussion in each report following the executive summary. 

## Priority: Clear communication of relevance to management with human dimensions first

### Mid-Atlantic report text: Seafood production (MAB)
>*Seafood production is a stated goal of optimal fishery management as part of the definition of “benefits to the nation” under MSA. Both commercial and recreational fishing contributes to seafood production, the latter for personal consumption, and indicators for each of these human activities track management performance against this objective.* 
>
>*The MAFMC only manages a portion of the total commercial landings that occur in the MAB region.  For example, blue crabs represent a substantial portion of category D (Benthivores) landings (Table \@ref(tab:proplandingsrevMAB)). Therefore in 2016, MAFMC accounted for 15% of the Benthivore landings and 12% of the revenue generated from those landings in the MAB.*

```{r proplandingsrevMAB, echo=FALSE, message=FALSE, warning=FALSE}
tabl <- "
|Groups|MAB Landings|MAB Revenue|
|:----------------|:------------|:-----------|
| Piscivore       | 0.16        | 0.50       |
| Planktivore     | 0.64        | 0.93       |
| Benthivore      | 0.15        | 0.12       |
| Benthos         | 0.62        | 0.10       |
"
#cat(tabl) # output the table in a format good for HTML/PDF/docx conversion

df<-read_delim(tabl, delim="|")
df<-df[-c(1,2) ,c("Groups","MAB Landings", "MAB Revenue")]
knitr::kable(
  df, booktabs = TRUE,
  caption = 'Proportion of landings and revenue derived from managed species in the Mid-Atlantic region.'
) %>%
  kable_styling(latex_options=c("hold_position"))
```
>
>*Fig \@ref(fig:seafoodlandingsMAB) shows the removals for human consumption of trophic groups including both all species landed in the MAB as well as the subset of those removals managed by the MAFMC.  Landings for managed species are all trending up in recent years, but only Benthivore landings are above the long-term mean. There is a significant decline in MAFMC-managed landings of benthos. We note that time series at the Mid-Atlantic regional scale may not include all state landings prior to 1994.*
>
>*Total commercial seafood landings from all species and from MAFMC managed species in the MAB indicate total seafood production. Years prior to 1977 included foreign landings, so we begin the time series in 1986. Recent landings are all domestic fisheries. Looking across all regions, there is a significant recent decrease in seafood landings, indicating high risk to regional domestic seafood production.* 
>
>*Recreational seafood landings (as opposed to total landings which include catch and release that are captured under other risk elements/indicators) were used to assess food use of recreationally caught fish in the Mid-Atlantic. This trend is also declining.*

>**Fig \@ref(fig:seafoodlandingsMAB). Mid-Atlantic seafood production indicators.**  Mid-Atlantic Council-managed seafood landings (red) and total commercial landings (black) A: by feeding guild, and B: summed across guilds. C: Total recreational harvest in the Mid-Atlantic. Light orange trendlines indicate significant long term increases, and violet trendlines indicate significant long term decreases. 

### New England report text: Seafood production (GOM and GB)
>*Seafood production is a stated goal of optimal fishery management as part of the definition of “benefits to the nation” under MSA. Both commercial and recreational fishing contributes to seafood production, the latter for personal consumption, and indicators for each of these human activities track management performance against this objective.*  
>
*Commercial landings include all seafood landings in the region, including species not managed by NEFMC. For example, category D, Benthivores, includes lobsters, which are a substantial portion of the landings and drive increases in landings and revenue. In 2016, NEFMC managed stocks made up from 5%-98% of total landings by category, as detailed below (Table \@ref(tab:proptableNE).* 

```{r proptableNE, echo = F, message=FALSE, warning=FALSE}
#Use this to create table of proportion of landings/revenue derived from NEFMC species (stargazer produces latex. Set eval = F)
#library(stargazer)
#convert to kable
gom_landings <- SOE.data.2018[grepl("GOM Landings 2016", SOE.data.2018$Var),]$Value
gom_landings <- gom_landings[c(1,3,2,4)]
joint_gom_landings <- SOE.data.2018[grepl("GOM Joint Landings 2016", SOE.data.2018$Var),]$Value
joint_gom_landings <- joint_gom_landings[c(1,3,2,4)]

gb_landings <- SOE.data.2018[grepl("GB Landings 2016", SOE.data.2018$Var),]$Value
gb_landings <- gb_landings[c(1,3,2,4)]

joint_gb_landings <- SOE.data.2018[grepl("GB Joint Landings 2016", SOE.data.2018$Var),]$Value
joint_gb_landings <- joint_gb_landings[c(1,3,2,4)]

gom_revenue <- SOE.data.2018[grepl("GOM Revenue 2016", SOE.data.2018$Var),]$Value
joint_gom_revenue <- SOE.data.2018[grepl("GOM Joint Revenue 2016", SOE.data.2018$Var),]$Value
gom_revenue <- gom_revenue[c(1,3,2,4)]

gb_revenue <- SOE.data.2018[grepl("GB Revenue 2016", SOE.data.2018$Var),]$Value
joint_gb_revenue <- SOE.data.2018[grepl("GB Joint Revenue 2016", SOE.data.2018$Var),]$Value
joint_gom_revenue <- joint_gom_revenue[c(1,3,2,4)]

df <- data.frame(Groups = c("Piscivore","Planktivore","Benthivore","Benthos"),
                 gom_landings = gom_landings+joint_gom_landings,
                 gb_landings = gb_landings+joint_gb_landings,
                 
                 gom_revenue = gom_revenue + joint_gom_revenue,
                 gb_revenue = gb_revenue + joint_gb_revenue)
                 

names(df) <- c("Groups", "GOM Landings", "GB Landings", "GOM Revenue",
                "GB Revenue")

kable(df, booktabs = TRUE, digits=2, caption = "Proportion managed by NEFMC") %>%
  kable_styling(font_size =8, latex_options=c("hold_position"))
#stargazer(df, summary = F, rownames = T, title = "Proportion of catch managed by NEFMC (2016)", header = F)
```
>
*Figure \ref{fig:seafoodlandingsGOM} shows the removals for human consumption both at the entire EPU level as well as those removals managed by the NEFMC. Landings of piscivores have decreased over the long term in both systems. Benthos landings show no long term trends in either system. Other groups have a decreasing landings trend in either GOM or GB.*
>
*Total commercial seafood landings from all species and from NEFMC managed species indicate total seafood production in the GOM and GB, which has declined over the long term.* 
>
*Recreational seafood landings (as opposed to total landings which include catch and release that are captured under other risk elements/indicators) were used to assess food use of recreationally caught fish. This trend is also declining.* 

>**Fig \@ref(fig:seafoodlandingsGOM). New England seafood production indicators.** New England Council-managed seafood landings (red) and total commercial landings (black) A: by feeding guild in the Gulf of Maine; B: by feeding guild on Georges Bank; C: summed across guilds for Gulf of Maine (top) and Georges Bank (bottom). D: Total recreational harvest in New England. Violet trendlines indicate significant long term decreases. 

During the Council meetings, there were questions regarding mechanisms for declines in seafood landings (e.g. could this be the result of management? Answer: yes). This led to conversation about the need for multiple indicators; while a single data stream indicates where we are with respect to a single objective, the full suite of indicators are needed to tease out multiple factors underlying the trends.

## Priority: Synthesis across indicators within a section
In this second example from the main body of the reports, we demonstrate synthesis across multiple indicators within a report section; connecting the physical oceaographic and low trophic level indicators to managed species in the Mid-Atlantic. The same indicators were presented using data from the Gulf of Maine and Georges Bank in the New England report, with text noting the differences and similarities between the areas (see [Supporting Information, S3](https://s3.amazonaws.com/nefmc.org/2_Ecosystem-Status-Report.pdf)).

### Mid-Atlantic report text: Ecosystem Conditions and Productivity
>
*Productivity of the system can be influenced by many factors.  Temperature affects the behavior and physiology of marine organisms while changes in productivity and species composition at the base of the food web can influence juvenile survival. In this section we report temperature and lower trophic level  production trends and annual cycles for the most recent year.  We also look at fish productivity through recruitment and fish condition.*
>
>### *Long-term ocean temperature (coastwide)*
>
*Sea surface temperature (SST) measurements have been collected on the Northeast Continental Shelf since the mid-1800s (Fig \@ref(fig:longtermsst)). The highest mean annual temperature in this time series was recorded in 2012, as the ecosystem warmed above the levels last seen in the late 1940s. The 2017 datum is the sixth highest temperature in the time series. The positive trend over the full time series (1856-2016) is significant, and the qualitative trend over the most recent decade of the time series appears even greater.*

>**Fig \@ref(fig:longtermsst). Long-term sea surface temperatures on the Northeast Continental Shelf.** The light orange trendline indicates a significant long term increase.

>### *Annual cycles (2017) in ocean temperature and primary production (MAB)*
>
*The Mid-Atlantic experienced above average sea surface temperatures (SSTs) during 2017. In Fig \@ref(fig:SSTPPDCHLMAB), the long term mean SST is shown as a black line with areas representing plus and minus one standard deviation of the mean as a shade of gray. SSTs for 2017 that were above the mean are shown in red and below the mean in blue, with emphasis added when the temperature exceeded or decreased below one standard deviation of the mean. Last winter was characterized by well above average temperatures in the Mid-Atlantic that transitioned to generally moderate conditions during summer. The Bight returned to warm conditions during October and remained above average for the balance of the year.*

>**Fig \@ref(fig:SSTPPDCHLMAB). 2017 Mid-Atlantic temperature and production cycles.** Sea Surface Temperature (SST; A), primary production (B), and Chlorophyll a (Chl a; C) over 2017 (colored polygons) compared against long-term mean (black line) and +/- 1 standard deviation (s.d., grey polygon) in the Mid-Atlantic. Red and dark green polygons respectively indicate 2017 temperature or primary production in excess of 1 s.d. above the long term mean, while orange and light green respectively indicate temperature and primary production/Chl a above the long term mean but within 1 s.d. Similarly, light blue polygons for all three indicate values below the long term mean but within 1 s.d. Only one observation in dark blue was more than 1 s.d. below the long term mean.

>###*Patterns in the lower trophic levels (MAB)*
>
*Chlorophyll a (CHL), an index for phytoplankton biomass, was above average in 2017, but there has been no distinct trend over the time series.   Primary production (PP) was also above average during most of 2017 throughout the MAB and has had an upward trend since 2004.  The high PP rates in the summer are likely due to increased remineralization of nutrients and regenerated production by smaller phytoplankton species.  This suggests that while overall PP may be increasing, not all of excess PP may be available to higher trophic levels.* 
>
*There is a coherent pattern between the primary production anomaly and the copepod size index for the MAB, with distinct peaks in production centered around 2002, 2010, and 2015, when the copepod size index was positive (Fig \@ref(fig:MABecoprod)). The copepod size index relates the abundance anomaly of small bodied copepods to the abundance of a large bodied copepod, Calanus finmarchicus. Additionally, Centropages typicus, an important copepod in the MAB, exhibits a long-term decline in abundance, with negative anomaly observations  beginning in the early 2000’s.*
>
>### *Groundfish condition (coastwide)*
>
*Fish condition is measured as the weight at a given length-–a measure of “fatness”. This information is from NEFSC bottom trawl surveys and shows a decline in condition across most species around 2000. Between 2010-2013 condition started to improve for many species, while black sea bass, goosefish and male spiny dogfish remained thinner for their length on average. This matches the trend in small-large copepods, perhaps reflecting changing nutrition across many species contributing to changes in condition.* 
>
>
>### *Groundfish productivity (MAB)*
>
*The number of small fish relative to the biomass of larger fish of the same species from the NEFSC survey is a simple measure of productivity, intended to complement model-based stock assessment estimates of recruitment for commercial species. There is a general decrease in this indicator when aggregated across managed species in the Mid-Atlantic.*

>**Fig \@ref(fig:MABecoprod). Mid-Atlantic ecosystem productivity indicators.** Small-large copepod index with primary productivity anomaly (A); *C. typicus* abundance anomaly, where the violet trendline indicates a significant long term decrease (B); groundfish condition in fall, where dark shades indicate better condition and light shades poorer condition (C); and groundfish productivity for MAFMC managed species in the Mid-Atlantic: the average of spring and fall anomalies of recruit abundance per spawner biomass. Colors indicate anomalies for individual species: summer flounder, scup, black sea bass, and bluefish (D).

During each Council meeting, these indicators were shown together to further emphasize the potential linkages. In particlar, the concurrent drop in zooplankton and fish condition during the early 2000's was of interest to both Councils, and the apparent decrease in productivity across managed fish generated much discussion with the Mid-Atlantic Council. 

# Discussion
Rising to the "so what" challenge has improved ecosystem reporting in the Northeast US in terms of management gains, scientific contributions, and infrastructure for efficient use of limited reporting resources. Our approach was to put into practice lessons learned from other regions and from scientific groups within our region [@levin_integrated_2009, @levin_guidance_2014, @depiper_operationalizing_2017]. This resulted in additional lessons learned that are broadly applicable to reporting in support of ecosystem based natural resource management. We detail each of these points in sections below, as well as work in progress for 2019 reporting building on lessons learned.

## Management gains
The changes to ecosystem reporting intended to improve relevance to management clearly resonated with the Councils. In the past, Councils did not reserve space in busy agendas for ecosystem reporting. The SOE report is now being requested annually, and staff from both Councils participated in SOE planning meetings for the 2019 report. This has resulted in an effective annual process where ecological contextual information is presented. Regular reporting within a Council process builds familiarity with the material, and can result in changes to tactical decisions when ecosystem information is combined with stock assessment information [@zador_ecosystem_2016]. 

Although the SOE report is aligned with general management objectives and of interest to the Councils, tactical management decisions in the Northeast US are still based on stock-specific analyses. While management decision criteria based on ecosystem indicator thresholds have been suggested and analyzed in general and for the Northeast US  [@murawski_definitions_2000; @link_translating_2005; @fay_testing_2013; @large_quantifying_2015; @fay_management_2015], tactical system-level management measures have rarely been implemented (aside from the system level catch limit in the U.S Bering Sea [@witherell_ecosystem-based_2000]). Nevertheless, information from our SOE reports has already been used in current strategic management. 

The MAFMC has integrated State of the Ecosystem report indicators within an ecosystem-level risk assesssment [@gaichas_implementing_2018], the initial step in their implementation of an ecosystem approach to fishery management [@gaichas_framework_2016]. The MAFMC risk assessment was done with managers and stakeholders in our region, further clarifying the list of ecosystem-level management objectives. For example, indicators associated with management performance were developed to assess risks to meeting management objectives [@gaichas_implementing_2018]. For 2019 and beyond, MAFMC wants to see the SOE report annually with an update to their risk assessment indicators as part of EAFM. In particular, they requested further development of management-oriented indicators such as other ocean uses and regulatory complexity. 

## Scientific contributions
Ecological synthesis is an important and notoriously difficult scientific endeavor [@ford_method_2001; @davanzo_symposium_2008]. While we strive for synthesis in the SOE reports, there is much further work to be done. However, because the SOE reports on scientific progress to date in many fields, connections drawn here can result in collaborative research going forward to improve our understanding. For example, the ecosystem productivity indicators shown above that elicited much discussion from the MAFMC have resulted in research linking zooplankton to fish productivity [@perretti_regime_2017].  In addition, there are research projects in progress linking zooplankton productivity to fish condition, and examining changes in the timing of spawning that may affect condition measurements. Management interest in these research questions is stimulated by their presentation in the SOE reports and can help prioritize distribution of temporary resources.

Components used here for reporting are also immediately applicable in a scientific context, such as using conceptual models for qualitative network modeling to evaluate simple system perturbations in an integrated social-ecological system [@reum_qualitative_2015; @harvey_using_2016; @zador_linking_2017]. For example, the Georges Bank conceptual model has been used to evaluate perturbation impacts to management objectives when different levels of detail in ecology and human dimensions are considered [@wildermuth_structural_2017]. 

Technical methods evaluated for ecosystem reporting also reflect an important scientific contribution. For example, indicator analysis is evolving to address time series autocorrelation in principal components analysis [@planque_principal_2018]. In the Northeast US, simulation work done to improve our standardized trend analysis found that widely applied methods may give unreliable statistical significance for shorter indicator time series [@hardison_simulation_nodate]. 

## Improved reporting infrastructure
Automation and transparency are increasingly desirable qualities for general reproducibility in science [@national_academies_of_sciences_open_2018]. These are useful not just in theory, but also for practical report production. The Rmarkdown and GitHub workflow we used to produce the SOE was efficient, traceable, and allowed effective collaboration. This framework also facilitated quick turnaround on further management requests. For example, the MAFMC risk assessment was completed within months of the Council's initial request based on the 2017 SOE as a starting point [@gaichas_implementing_2018]. Further, in June 2018, NEFMC requested a prototype ecosystem-level risk assessment as well, and production was simple: indicators for the Gulf of Maine and Georges Bank replaced those for the Mid-Atlantic Bight. This quick analysis gave New England managers a provisional example to determine whether a more in-depth analysis would be useful for them.  

After the 2018 Council reporting cycle, further improvements were made to allow access to the indicator data in the 2018 report. Web access to indicator data was implemented through the [National IEA webpage](https://www.integratedecosystemassessment.noaa.gov/regions/northeast/Indicator-data) as part of a national initiative. Standard metadata for indicators are also included in the dataset, implemented in a data access program named  [ERDDAP](https://coastwatch.pfeg.noaa.gov/erddap/index.html) [@simons_erddap_2017]. The goal is to keep indicator data available and accessible for ongoing synthesis but also to have this information widely available for modeling or other analyses.

To continue building an efficient reporting structure, the following steps are in progress for the 2019 report. A similar interdisciplinary planning workshop was held in July 2018 to further improve synthesis. Because issues with data confidentiality have been resolved, a [public GitHub repository for the 2019 report data](https://github.com/NOAA-EDAB/ecodata) has been set up. This repository already includes intermediate data processing [documentation](https://noaa-edab.github.io/soe/) for improved transparency and reproducibility. The 2019 SOE reports will be produced in repositories for the [MAFMC](https://github.com/NOAA-EDAB/SOE-MAFMC) and [NEFMC](https://github.com/NOAA-EDAB/SOE-NEFMC). Plans are in place to use these frameworks for retrospective documentation of past indicators, development of new indicators, and development of reports for other management bodies. 

Improved reporting infrastructure will lead to further efficiencies over time. In the past, limited resources required sidelining some detailed analyses to prioritize report production. Now and in upcoming years, time freed up by automating reporting allows more in depth analyses including formal indicator selection and evaluation, threshold analysis, and synthetic multivariate methods such as dynamic factor analysis [@large_defining_2013; @tam_towards_2017; @otto_quantitative_2017; @samhouri_defining_2017]. 

Finally, continued consultation with the Councils and other management bodies on tailored integrated ecosystem reporting resulted in development of new products. Automated stock specific ecosystem reports are currently in development to be further refined for stock assessment working groups: a prototype Ecosystem Context for Stock Assessment report was provided for the 2018 summer flounder assessment (see  [ECSA](https://noaa-edab.github.io/ECSA/)). This product is more interactive and intended for a scientific audience (e.g. with error bars on figures, links to methods, and data download capability), but many of the same data and analyses are used in the SOE. The aim is to develop an ecosystem reporting data framework that is transparent, accessible, and adaptable to future analyses requested by managers and scientists alike.

# Conclusion
Overall, we have found that addressing the "so what" question with respect to ecosystem reporting is an ongoing, but worthwhile challenge. Flexibility and responsiveness to audience is important, so we plan to further adapt reporting methods as the needs of managers change. It is possible to retain elements of ecosystem reporting frameworks linking drivers, pressures, states, impacts, and responses and ecosystem services approaches [@patricio_dpsirtwo_2016] while adjusting to regional needs. Focus on synthesis and on indicators that directly address management objectives will continue to be vital. There are no plans to concentrate only on today's management relevant subset of indicators, but rather to maintain a wide range of ecosystem indicators. Tailored reports can then be made selectively from a "mothership" of ecosystem data (e.g. ESR on the web) for different audiences. Overall, we have developed this straightforward process to be flexible and adjustable to needs in any region/management context. Ultimately, open science principles combined with active solicitation of manager and stakeholder needs should be an effective way forward for improving the ecosystem basis of resource management.

# Supporting Information

**S1** [**State of the Ecosystem Technical Documentation.**](https://noaa-edab.github.io/tech-memo/) Detailed methods and references for each indicator and analysis in the State of the Ecosystem reports, with links to indicator data. 

**S2** [**Mid-Atlantic State of the Ecosystem 2018.**](http://www.mafmc.org/s/Tab04_State-of-the-Ecosystem-Apr2018.pdf) Report presented to the Mid-Atlantic Fishery Management Council on 11 April 2018.

**S3** [**New England State of the Ecosystem 2018.**](https://s3.amazonaws.com/nefmc.org/2_Ecosystem-Status-Report.pdf) Report presented to the New England Fishery Management Council on 19 April 2018.

# Acknowledgments
We gratefully acknowledge Dr. John Boreman, chair of the MAFMC Scientific and Statistical Committee, for bluntly pointing out that initial draft ecosystem reporting lacked clear connections to management issues (and by extension, suggesting the title to this paper). Richard Seagraves, Mid-Atlantic Council staff (retired), contributed valuable insights on potential management uses of the SOE at the August 2017 workshop. We are grateful to Mark Terciero (NEFSC) for review of the details of stock assessment information, to Steve Traynor (Traynor Design) for developing the conceptual model graphics used in 2018, to Andrew Beet (Integrated Statistics and NEFSC) for editing the online technical methods, to Heather Haas (NEFSC) for information on sea turtle ecology, to Kimberly Murray (NEFSC) for information on seals, to Dave Kulis (Woods Hole Oceanographic Institution) for information on New England shellfish bed closures, to Lisa Calvo (Rutgers University) and Karl Roscherand (Maryand Department of Natural Resources) for aquaculture information, to Amani Bassyouni (Virginia Department of Health) for Chesapeake Bay algal bloom information, and to Mike Hammil (Department of Fisheries and Oceans, Canada) for background information on gray seals. Development of ecosystem reporting in the Northeast US has been greatly facilitated and improved through the International Council for the Exploration of the Sea's Working Group on the Northwest Atlantic Regional Sea (ICES WGNARS). Ecosystem reporting is not possible without data collection programs. We gratefully acknowledge everyone supporting and maintaining the satellite observering systems, field programs and surveys (for oceanography, habitat, plankton, fish, marine mammals, seabirds), fishery and economic information systems, and modeling programs for stock assessment, regional oceanography, weather, and climate in the Northeast US.

\nolinenumbers

# References
<div id="refs"></div>

\newpage

```{r, echo = FALSE, results = "asis"}
cat("\\newgeometry{top=0.85in, left=0.5in, right=0.5in, footskip=0.75in}")
cat("\\fancyhf{}")
cat("\\renewcommand{\\headrulewidth}{0pt}")
cat("\\renewcommand{\\footrule}{}")
```

# Figures

```{r conceptual, fig.cap="Overview of ecosystem relationships for the Mid-Atlantic Ecosystem. Human activities link to high level strategic management objectives (MAFMC FMP). Components are represented by indicators in this report, and key paths connecting components and objectives are highlighted.", fig.height=6, fig.width=4, out.width='\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
#knitr::include_graphics(file.path(image.dir, 'SOE_MAB_ConceptMod.png'))
knitr::include_graphics(file.path(image.dir, 'MAB_conmod_overview.jpg'))

```
\newpage

```{r map, fig.cap="Mid-Atlantic Bight (MAB) spatial extent. Geographic units for Georges Bank (GB) and Gulf of Maine (GOM) are also indicated.", fig.height=6, fig.width=4, out.width='\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
image_read(file.path(image.dir,"NEshelfEcoRegionsALL.png")) %>%
image_trim()

```
\newpage

```{r KOBE, fig.cap="Summary of single species status for Mid-Atlantic Fishery Management Council (MAFMC) and jointly managed (Joint) stocks. Dashed lines indicate thresholds for fishing mortality rate relative to the limit (F/Fmsy = 1) and for biomass relative to the minimum (B/Bmsy=0.5). The dotted line indicates the biomass target (B/Bmsy = 1). Status is based on the most recent published stock assessment or linked assessment update for each stock (2017 unless otherwise noted):", fig.height=7, fig.width=7, out.width='\\linewidth', fig.align='center', echo = F, message = FALSE, warning = FALSE, eval = T}
#knitr::include_graphics(file.path(image.dir, 'MAFMC_joint_stocks_2017.pdf'))

dat <- read.csv(file.path(data.dir, "2017assess.csv"))

stocks <- unique(dat$Entity.Name)
n.stocks <- length(stocks)

decoder <- read.csv(file.path(data.dir,"2017decoder.csv"))
# set up the headers for most.recent structure - will contain oldest Assessment.Year
most.recent <- dat[1,]
most.recent <- most.recent[-1,]

for (i in 1:n.stocks){
  temp <- dat[dat$Entity.Name == decoder$Entity.Name[i],]
  most.recent <- rbind(most.recent,temp[temp$Assessment.Year == max(temp$Assessment.Year),])
}
#cbind(n.stocks,length(most.recent[,1]))

# get the max of F.Flimit and F.Fmsy and the max of B.Blimit and B.Bmsy
Frat <- most.recent$F.Fmsy
Brat <- most.recent$B.Bmsy
#Frat[6] <- most.recent$F.Flimit[6]  # Ocean Quahog use Flimit because no Fmsy
#Frat[18] <- 0.88  # hardwire average of the two GOM models for GOM cod
#Brat[18] <- 0.155 # hardwire average of the two GOM models for GOM cod
#model averages have been calculated and included in F/Fmsy column in 2017assess.csv
#cbind(most.recent$Entity.Name,most.recent$F.Flimit,most.recent$F.Fmsy)

# figure out appropriate range for axes WARNING HARD CODED
#max(Frat,na.rm=T)
#max(Brat,na.rm=T)
x.r <- c(0,3)
y.r <- c(0,3)

# set some colors
my.col <- rep(NA,n.stocks)
MA.col <- "blue"
NE.col <- "blue"
BO.col <- "purple"
for (i in 1:n.stocks){
  if(decoder$Council[i] == "MAFMC") my.col[i] <- MA.col
  if(decoder$Council[i] == "NEFMC") my.col[i] <- NE.col
  if(decoder$Council[i] == "Both")  my.col[i] <- BO.col
}

# create new matrix for plotting
xx <- as.data.frame(cbind(decoder[,2:8],Frat,Brat,my.col))
newlist <- as.factor(decoder$Code)
others <- as.factor(c("7 Skates", "B. Tilefish"))
sppcodes <- unlist(list(newlist, others))
MA.unknown <- sppcodes[c(51,3,4,47,48)] #mackerel, Loligo, Illex, monkfish unknown
#MA.unknown <- decoder$Code[c(1,3,4,8)] #BSB known
#NE.unknown <- c(decoder$Code[c(14,23,33)],"7 Skates")
NE.overfished <- sppcodes[c(17,19)] # GB cod, halibut
NE.unknown <- sppcodes[c(14,23,33,35,37,47,48,50)] #Red deepsea crab,  Offshore hake, GOM winter flounder, Witch flounder, GB YT,2 monkfish, 7 skates unknown


# break out the Councils
MA <- xx[xx$Council == "MAFMC",]
NE <- xx[xx$Council == "NEFMC",]
BO <- xx[xx$Council == "Both",]
MABO<-rbind(MA, BO)
NEBO<-rbind(NE, BO)

#if(saveplots) png(file = "MAFMC_joint_stocks_2017.png",  units="in", width = 6, height = 6, res=1200)
plot(MABO$Brat,MABO$Frat,xlim=x.r,ylim=y.r,xlab="B/Bmsy",ylab="F/Fmsy",pch=16,col=my.col[c(1:11,47:49)])
  abline(v=0.5,lty=2)
  abline(v=1,lty=3)
  abline(h=1,lty=2)
  title(expression("MAFMC " * phantom("and Joint Stocks")), col.main="blue")
  title(expression(phantom("MAFMC ") * "and " * phantom("Joint Stocks")), col.main="black")
  title(expression(phantom("MAFMC and ") * "Joint" * phantom(" Stocks")), col.main="purple")
  title(expression(phantom("MAFMC and Joint") * " Stocks"), col.main="black")  
  legend('topright',legend=MA.unknown,pch=NA,text.col=my.col[c(1,3,4,47,48)], title="Unknown Status", title.col = "black")
  text(MABO$Brat,MABO$Frat,labels=MABO$Code,pos=MABO$my.pos3,col=my.col[c(1:11,47:49)],cex=0.8)
#if(saveplots) savePlot("MAFMC_Joint_stocks.png", type='png')
#if(saveplots) dev.off()

#if(saveplots) pdf(file = "NEFMC_joint_stocks.pdf",  width = 6, height = 6)
#if(saveplots) png(file = "NEFMC_joint_stocks.png",  units="in", width = 6, height = 9, res=1200)
# plot(NEBO$Brat,NEBO$Frat,xlim=x.r,ylim=y.r,xlab="B/Bmsy",ylab="F/Fmsy",pch=16,col=my.col[12:49])
#    abline(v=0.5,lty=2)
#    abline(v=1,lty=3)
#    abline(h=1,lty=2)
#    title(expression("NEFMC " * phantom("and Joint Stocks")), col.main="blue")
#    title(expression(phantom("NEFMC ") * "and " * phantom("Joint Stocks")), col.main="black")
#    title(expression(phantom("NEFMC and ") * "Joint" * phantom(" Stocks")), col.main="purple")
#    title(expression(phantom("NEFMC and Joint") * " Stocks"), col.main="black")  
#    legend('topright',legend=NE.overfished,pch=NA,title="Overfished, F \nStatus Unknown",bty="n", text.width=strwidth("Offshore Hake"), inset=c(0,.05))
#    legend('right',legend=NE.unknown,pch=NA,title="Unknown Status", bty="n")
#    text(NEBO$Brat,NEBO$Frat,labels=NEBO$Code,pos=NEBO$my.pos3,col=my.col[12:49],cex=0.8)
#if(saveplots) savePlot("NEFMC_Joint_stocks.png", type='png')
#if(saveplots) dev.off()

```

Mackerel [@nefsc_64th_2018], 2016 Fluke ( [summer flounder](http://www.mafmc.org/s/Summer_flounder_2015_Assess_Update.pdf)), [Dogfish](http://www.mafmc.org/s/2017-Status-Report-for-spiny-dogfish.pdf), [Tilefish](http://www.mafmc.org/s/Golden_Tile_Assessment_Update2017-POPDY.pdf), 2015 Bluefish [@nefsc_60th_2015], [Butterfish](http://www.mafmc.org/s/Butterfish-2017-Stock-Assessment-Update.pdf), Ocean quahog [@nefsc_63rd_2017], [Scup](http://www.mafmc.org/s/5Scup_2017_Assesssment_Update.pdf), Black sea bass [@nefsc_62nd_2017], Surfclam [@nefsc_61st_2017], [Longfin squid](http://www.mafmc.org/s/Doryteuthis_update_April_2017.pdf), [Illex squid](http://www.mafmc.org/s/Illex-illecebrosus_data_update_report_for_2017_MAFMC_SSC_ABC.pdf), Northern and Southern Monkfish [@richards_2016_2016].

\newpage

```{r sppvul, fig.cap="Climate-vulnerable fisheries landings in key Mid-Atlantic fishing ports.", echo = F, fig.align='center', eval = T, out.width='\\linewidth'}
knitr::include_graphics(file.path(image.dir, 'Sp_vulnerability_MAB.jpg'))
```

\newpage

```{r seafoodlandingsMAB, fig.cap="Mid-Atlantic seafood production indicators. Mid-Atlantic Council-managed seafood landings (red) and total commercial landings (black) A: by feeding guild, and B: summed across guilds. C: Total recreational harvest in the Mid-Atlantic. Light orange trendlines indicate significant long term increases, and violet trendlines indicate significant long term decreases.",echo = F, warning = F, include = T, fig.align='center', fig.keep='last', out.width='\\linewidth'}

## Figure dimensions
figureX <- multi_panel_figure(
   columns = 2,
   rows = 2)

## Ecosystem-wide and managed species total landings by feeding guild
## A: Apex predators, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos
guildland <- capture_base_plot({
  opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(3, 3.5, 1, 1))
  
  soe.plot(SOE.data.2018, "Time","Apex Predator Landings MAB", stacked = "Apex predators",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 1,end.start = 2007, x.start = 1986,
           ymin = FALSE, y.lower = 0 )
  
  soe.plot(SOE.data.2018, "Time", "Piscivore Landings MAB", stacked = "Piscivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Piscivore MAFMC managed species sea food MAB")
  
  soe.plot(SOE.data.2018, "Time", "Planktivore Landings MAB", stacked = "Planktivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Planktivore MAFMC managed species sea food MAB")
  
  soe.plot(SOE.data.2018, "Time", "Benthivore Landings MAB", stacked = "Benthivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Benthivore MAFMC managed species sea food MAB")
  
  soe.plot(SOE.data.2018, "Time", "Benthos Landings MAB", stacked = "Benthos",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,end.start = 2007, x.start = 1986,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Benthos MAFMC managed species sea food MAB")
  
  soe.stacked.axis("Year", expression("Landings, 10"^3*" tons"), x.line = 2, 
                   rel.x.text = 0.8, y.line=2, rel.y.text = 0.8)
})

## Fill the panels
figureX <- fill_panel(figureX, guildland, row = 1:2, column = 1)

## Ecosystem-wide and managed species total landings
totland <- capture_base_plot({
  opar <- par(mfrow = c(1, 1), mar = c (2, 2, 0, 0), oma = c(4, 2.5, 1.8, 1))
  
  soe.plot(SOE.data.2018, "Time", "Total Landings MAB", point.cex = 1, rel.y.text = 0.8, 
           rel.y.num = 0.6, scale.axis = 10^3, end.start = 2007, x.start = 1986,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Total managed landings MAB", x.label = 'Year', y.line = 2,
           rel.x.text = 0.8, rel.x.num = 0.6, x.line = 2,
           y.label = expression('Landings, 10'^3 * ' tons'))
  
})

figureX <- fill_panel(figureX, totland, row = 1, column = 2)

## Recreational landings
recland <-capture_base_plot({
  #opar <- par(mfrow = c(1, 1))
  soe.plot(SOE.data.2018, "Time", "Recreational Seafood MA", point.cex = 1, scale.axis = 10^6,
           end.start = 2008, x.label = 'Year', rel.y.text = 0.8, rel.y.num = 0.6, y.line = 2,
           rel.x.text = 0.8, rel.x.num = 0.6, x.line = 2,
           y.label = expression("Fish caught, 10"^6 *" n"))
})

figureX <- fill_panel(figureX, recland, row = 2, column = 2)

figureX
```


```{r seafoodlandingsGOM,  fig.cap = "New England seafood production indicators. New England Council-managed seafood landings (red) and total commercial landings (black) A: by feeding guild in the Gulf of Maine; B: by feeding guild on Georges Bank; C: summed across guilds for Gulf of Maine (top) and Georges Bank (bottom). D: Total recreational harvest in New England. Violet trendlines indicate significant long term decreases.", echo = F, fig.height=7, fig.keep='last', fig.align='center',warning = F, message = F, out.width='\\linewidth'}

## Figure dimensions
figureX <- multi_panel_figure(
   columns = 2,
   rows = 3)

#fig.height = 5.5,
## Gulf of Maine cosystem-wide and managed species total landings
#A: Apex predators, B: Piscivore, C: Planktivore, D: Benthivore, E: Benthos.
guildlandGOM <- capture_base_plot({
  opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(3, 3.5, 1, 1))
  
  soe.plot(SOE.data.2018, "Time","Apex Predator Landings GOM", 
           stacked = "Apex predators",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0, cex.stacked = 1)
  soe.plot(SOE.data.2018, "Time", "Piscivore Landings GOM", 
           stacked = "Piscivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Piscivore NEFMC managed species sea food GOM", mean_line = T,
           cex.stacked = 1)
  soe.plot(SOE.data.2018, "Time", "Planktivore Landings GOM", 
           stacked = "Planktivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 ="Planktivore NEFMC managed species sea food GOM", mean_line = T,
           cex.stacked = 1)
  soe.plot(SOE.data.2018, "Time", "Benthivore Landings GOM", 
           stacked = "Benthivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Benthivore NEFMC managed species sea food GOM", mean_line = T,
           cex.stacked = 1)
  soe.plot(SOE.data.2018, "Time", "Benthos Landings GOM", 
           stacked = "Benthos",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Benthos NEFMC managed species sea food GOM", mean_line = T,
           cex.stacked = 1)
  soe.stacked.axis("Year",expression("Landings, 10"^3*"metric tons"), x.line = 2, 
                   rel.x.text = 0.8, y.line=2, rel.y.text = 0.8)
})

## Fill the panels
figureX <- fill_panel(figureX, guildlandGOM, row = 1:2, column = 1)

## Georges Bank ecosystem-wide and managed species total landings
guildlandGB <- capture_base_plot({
  opar <- par(mfrow = c(5, 1), mar = c(0, 0, 0, 0), oma = c(3, 3.5, 1, 1))
  
  soe.plot(SOE.data.2018, "Time","Apex Predator Landings GB", 
           stacked = "Apex predators",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0, 
           cex.stacked = 1)
  soe.plot(SOE.data.2018, "Time", "Piscivore Landings GB", 
           stacked = "Piscivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Piscivore NEFMC managed species sea food GB", mean_line = T, 
           cex.stacked = 1)
  soe.plot(SOE.data.2018, "Time", "Planktivore Landings GB", 
           stacked = "Planktivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 ="Planktivore NEFMC managed species sea food GB", mean_line = T, 
           cex.stacked = 1)
  soe.plot(SOE.data.2018, "Time", "Benthivore Landings GB", 
           stacked = "Benthivores",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Benthivore NEFMC managed species sea food GB", mean_line = T, 
           cex.stacked = 1)
  soe.plot(SOE.data.2018, "Time", "Benthos Landings GB", 
           stacked = "Benthos",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 = "Benthos NEFMC managed species sea food GB", mean_line = T, 
           cex.stacked = 1)
  soe.stacked.axis("Year",expression("Landings, 10"^3*"metric tons"), x.line = 2, 
                   rel.x.text = 0.8, y.line=2, rel.y.text = 0.8)
})

## Fill the panels
figureX <- fill_panel(figureX, guildlandGB, row = 1:2, column = 2)

## Ecosystem-wide and managed species total landings
totland <- capture_base_plot({
  opar <- par(mfrow = c(2, 1), mar = c(0, 0, 0, 0), oma = c(2.5, 3, 1, 1))
  
  soe.plot(SOE.data.2018, "Time", "Total Landings GOM", point.cex = 1, 
           stacked = "GOM",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 =  "Total managed landings GOM")
  soe.plot(SOE.data.2018, "Time", "Total Landings GB", point.cex = 1, 
           stacked = "GB",status = F, suppressAxis = TRUE,
           endshade = T, rel.y.num = 0.6, full.trend = T, scale.axis = 10^3,
           end.start = 2007, x.start = 1964,
           ymin = FALSE, y.lower = 0 , extra = TRUE, x.var2 = "Time", 
           y.var2 =  "Total managed landings GB")
  soe.stacked.axis("Year",expression("Landings, 10"^3*"metric tons"), x.line = 2, 
                   rel.x.text = 0.8, y.line=2, rel.y.text = 0.8)
})

figureX <- fill_panel(figureX, totland, row = 3, column = 1)

## Recreational landings
recland <-capture_base_plot({
  #opar <- par(mar = c (0, 0, 0, 0), oma = c(3, 3.5, 1, 1))
  soe.plot(SOE.data.2018, "Time", "Recreational Seafood NE", point.cex = 1, scale.axis = 10^6,
           end.start = 2008, x.label = 'Year', rel.y.text = 0.8, rel.y.num = 0.6, y.line = 2,
           rel.x.text = 0.8, rel.x.num = 0.6, x.line = 2,
           y.label = expression("Fish caught, 10"^6 *" n"))
})

figureX <- fill_panel(figureX, recland, row = 3, column = 2)

figureX

```


```{r longtermsst, fig.cap="Long-term sea surface temperatures on the Northeast Continental Shelf. The light orange trendline indicates a significant long term increase.",  echo=F, message=FALSE, warning=FALSE , fig.height=2.5, fig.align = 'center'}
opar <- par(mar = c(4, 6, 2, 6))
soe.plot(SOE.data.2018, "Time", "long term sst", end.start = 2007, 
         line.forward = TRUE, point.cex = 0.8, rel.y.text = 1.1,
         x.line = 2, y.line = 2.3, x.label = 'Year', rel.y.num = 1.1,
         y.label = expression(paste("Mean SST (",degree,"C)")))

```


```{r SSTPPDCHLMAB, fig.cap="2017 Mid-Atlantic temperature and production cycles. Sea Surface Temperature (SST; A), primary production (B), and Chlorophyll a (Chl a; C) over 2017 (colored polygons) compared against long-term mean (black line) and +/- 1 standard deviation (s.d., grey polygon) in the Mid-Atlantic. Red and dark green polygons respectively indicate 2017 temperature or primary production in excess of 1 s.d. above the long term mean, while orange and light green respectively indicate temperature and primary production/Chl a above the long term mean but within 1 s.d. Similarly, light blue polygons for all three indicate values below the long term mean but within 1 s.d. Only one observation in dark blue was more than 1 s.d. below the long term mean.",echo = F, fig.show='hold', fig.align='default',warning = F, message = F,fig.height = 2.75, fig.width = 8, out.width='\\linewidth'}
## SST
par(mar = c(4, 4, 2, 1), mfrow = c(1,3))
doy <- as.numeric(SOE.data.2018[SOE.data.2018$Var == "sst mean 2017 MAB",]$Time)
val_2017 <- SOE.data.2018[SOE.data.2018$Var == "sst mean 2017 MAB",]$Value
val_LT <- SOE.data.2018[SOE.data.2018$Var == "sst mean long term MAB",]$Value
val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sst sd long term MAB",]$Value


# val_2017 <- approx(doy,val_2017, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
# val_LT <- approx(doy,val_LT, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
# val_LT_sd <- approx(doy,val_LT_sd, xout = seq(doy[1],doy[length(doy)],length.out = 365*1))$y
doy <- seq(doy[1],doy[length(doy)],length.out = 365*1)


above_mean <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] >= val_LT[i]){
    above_mean[i] <- val_2017[i]
  } else if (val_2017[i] < val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] <= val_LT[i]){
    below_mean[i] <- val_2017[i]
  } else if (val_2017[i] > val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] >= val_LT_sd[i] + val_LT[i]){
    above_sd[i] <- val_2017[i]
  } else if (val_2017[i] < val_LT_sd [i] + val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(val_2017)){
  if (val_2017[i] <= val_LT[i] - val_LT_sd[i]){
    below_sd[i] <- val_2017[i]
  } else if (val_2017[i] > val_LT[i] - val_LT_sd [i]){
    below_sd[i] <- NA
  }
}

#Lines for polygons
above_sd[is.na(above_sd)] <- val_LT_sd[which(is.na(above_sd))] + val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- val_LT[which(is.na(below_sd))] - val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- val_LT[which(is.na(below_mean))]

upper <- val_LT_sd + val_LT
lower <- val_LT - val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]), ylim = c(4,25), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,61,122,183,245,306,365), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Mean SST (",degree,"C)")), cex = 1.1)
mtext(1, line = 2.5, text = "Time", cex = 1.1)
text(15,21.5*.95,"A",cex = 1.5)
# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey85", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-val_LT), rev(above_mean)),
        col = "orange", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(val_LT + val_LT_sd)), rev(above_sd)),
        col = "red", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(val_LT - val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,val_LT, type = "l", lwd = 1, "grey90")
#points(doy,val_2017, type = "l", lwd = .5, "black")

par(mar = c(4, 4, 2, 1))
## primary production
doy <- seq(1,52,1)
ppd_val_2017 <- SOE.data.2018[SOE.data.2018$Var == "geometric mean ppd 2017 MAB",]$Value
ppd_val_LT <- SOE.data.2018[SOE.data.2018$Var == "geometric mean ppd long term MAB",]$Value
ppd_val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sd ppd long term MAB",]$Value

above_mean <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] >= ppd_val_LT[i]){
    above_mean[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] < ppd_val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] <= ppd_val_LT[i]){
    below_mean[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] > ppd_val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] >= ppd_val_LT_sd[i] + ppd_val_LT[i]){
    above_sd[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] < ppd_val_LT_sd [i] + ppd_val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(ppd_val_2017)){
  if (ppd_val_2017[i] <= ppd_val_LT[i] - ppd_val_LT_sd[i]){
    below_sd[i] <- ppd_val_2017[i]
  } else if (ppd_val_2017[i] > ppd_val_LT[i] - ppd_val_LT_sd [i]){
    below_sd[i] <- NA
  }
}


#Lines for polygons
above_sd[is.na(above_sd)] <- ppd_val_LT_sd[which(is.na(above_sd))] + ppd_val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- ppd_val_LT[which(is.na(below_sd))] - ppd_val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- ppd_val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- ppd_val_LT[which(is.na(below_mean))]

upper <- ppd_val_LT_sd + ppd_val_LT
lower <- ppd_val_LT - ppd_val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]),ylim = c(0,2.25), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,8,16,24,32,40,48), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Primary Production (gC m"^-2*"d"^-1*")")), cex = 1.1)
mtext(1, line = 2.5, text = "Time", cex = 1.1)
text(2,1.75*.95,"B", cex = 1.5)
# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey85", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (ppd_val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-ppd_val_LT), rev(above_mean)),
        col = "darkolivegreen1", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(ppd_val_LT + ppd_val_LT_sd)), rev(above_sd)),
        col = "darkolivegreen3", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(ppd_val_LT - ppd_val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,ppd_val_LT, type = "l", lwd = 1, "grey90")
#points(doy,ppd_val_2017, type = "l", lwd = .5, "black")
box(lty = 'solid', col = 'black',lwd = 1.25)

par(mar = c(4, 4, 2, 1))
## Chlorophyll a
chl_val_2017 <- SOE.data.2018[SOE.data.2018$Var == "geometric mean chl 2017 MAB",]$Value
chl_val_LT <- SOE.data.2018[SOE.data.2018$Var == "geometric mean chl long term MAB",]$Value
chl_val_LT_sd <- SOE.data.2018[SOE.data.2018$Var == "sd chl long term MAB",]$Value

above_mean <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] >= chl_val_LT[i]){
    above_mean[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] < chl_val_LT [i]){
    above_mean[i] <- NA
  }
}

below_mean <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] <= chl_val_LT[i]){
    below_mean[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] > chl_val_LT [i]){
    below_mean[i] <- NA
  }
}

above_sd <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] >= chl_val_LT_sd[i] + chl_val_LT[i]){
    above_sd[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] < chl_val_LT_sd [i] + chl_val_LT[i]){
    above_sd[i] <- NA
  }
}

below_sd <- NULL
for (i in 1:length(chl_val_2017)){
  if (chl_val_2017[i] <= chl_val_LT[i] - chl_val_LT_sd[i]){
    below_sd[i] <- chl_val_2017[i]
  } else if (chl_val_2017[i] > chl_val_LT[i] - chl_val_LT_sd [i]){
    below_sd[i] <- NA
  }
}


#Lines for polygons
above_sd[is.na(above_sd)] <- chl_val_LT_sd[which(is.na(above_sd))] + chl_val_LT[which(is.na(above_sd))]
below_sd[is.na(above_sd)] <- chl_val_LT[which(is.na(below_sd))] - chl_val_LT_sd[which(is.na(below_sd))] 
above_mean[is.na(above_mean)] <- chl_val_LT[which(is.na(above_mean))]
below_mean[is.na(below_mean)] <- chl_val_LT[which(is.na(below_mean))]

upper <- chl_val_LT_sd + chl_val_LT
lower <- chl_val_LT - chl_val_LT_sd

#Null figure
plot(NULL, xlim = c(doy[1],doy[(length(doy))]),ylim = c(0,2), las = 1, 
     ylab = "", yaxt = "n", xaxt = "n", xlab = "")
axis(2, cex.axis = 1.25, las = 1)
axis(1,  labels = c("Jan","Mar","May","July","Sep","Nov","Jan"), 
     at = c(1,8,16,24,32,40,48), cex.axis= 1.25)
mtext(2, line = 2.5, text = expression(paste("Chl ",alpha," mg m"^-3*"")), cex = 1.1)
mtext(1, line = 2.5, text = "Time", cex = 1.1)

# +/- 1 sd
polygon(c(doy, rev(doy)),
        c(upper, rev(lower)),
        col = "grey85", border = NA)

#Fills plot
polygon(c(doy, rev(doy)),
        c(below_mean + (chl_val_LT-below_mean), rev(below_mean)),
        col = "lightblue", border = NA)
polygon(c(doy, rev(doy)),
        c(above_mean - (above_mean-chl_val_LT), rev(above_mean)),
        col = "darkolivegreen1", border = NA)
polygon(c(doy, rev(doy)),
        c(above_sd - (above_sd-(chl_val_LT + chl_val_LT_sd)), rev(above_sd)),
        col = "darkolivegreen3", border = NA)
polygon(c(doy, rev(doy)),
        c(below_sd + (below_sd-(chl_val_LT - chl_val_LT_sd)), rev(below_sd)),
        col = "blue", border = NA)
points(doy,chl_val_LT, type = "l", lwd = 1, "grey90")
#points(doy,chl_val_2017, type = "l", lwd = .5, "black")
box(lty = 'solid', col = 'black',lwd = 1.25)
text(2,2.5*.95,"C", cex = 1.5)

```

```{r MABecoprod, fig.cap="Ecosystem productivity indicators. Small-large copepod index with primary productivity anomaly (A); *C. typicus* abundance anomaly, where the violet trendline indicates a significant long term decrease (B); groundfish condition in fall, where dark shades indicate better condition and light shades poorer condition (C); and groundfish productivity for MAFMC managed species in the Mid-Atlantic: the average of spring and fall anomalies of recruit abundance per spawner biomass. Colors indicate anomalies for individual species: summer flounder, scup, black sea bass, and bluefish (D).", echo = F, fig.keep='last', fig.align='center', warning = F, message = F, out.width='\\linewidth'}

## Figure dimensions
figureX <- multi_panel_figure(
   columns = 2,
   rows = 2)

par(mgp=c(1.5,0.3,0))
opar <- par(mar = c(4,4.75,2,4.75))
mab_prim_prod <- finder(SOE.data.2018, "annual ppd ratio anomaly MAB")
mab_copepod_anom <- finder(SOE.data.2018, "Small-Large copepod Index MAB")

PPcopes <- capture_base_plot({ 
  #par(las = 1)
  #plot(1:5)
  #title("One to five")
  #small-large copepod index
  #opar <- par(mar = c(4,4.75,2,4))
  #mab_prim_prod <- finder(SOE.data.2018, "annual ppd ratio anomaly MAB")
  #mab_copepod_anom <- finder(SOE.data.2018, "Small-Large copepod Index MAB")
  #usr <- par("usr")
  #par(mgp=c(axis.title.position, axis.label.position, axis.line.position))
  plot(NULL,ylim = c(-1.5,1.5), pch = 16, lwd = 3,xlim = c(1998,2017),
       cex = 1, ylab = "Small-Lg Copepod Index", las = 1, xaxt = "n", cex.axis = 0.6, xlab = "", tck=-0.01, cex.lab=0.8)
  abline(h = 0, col  = "grey", lwd = 1, lty = 2) 
  with(SOE.data.2018[SOE.data.2018$Var == mab_copepod_anom,], points(Time[22:39], Value[22:39],
                                                                     type = "o", col = "black", ylim = c(-1.5,1.5), pch = 16, lwd = 2,las = 1))
  #mtext(side = 2, line = 2, "Small-Lg Copepod Index", cex = 0.8)
  #text(1998,1.4,"B",cex = 1.75)
  
  par(new = T)
  
  #primary productivity
  with(SOE.data.2018[SOE.data.2018$Var ==  mab_prim_prod[1],], plot(Time, Value,
                                                                    type = "o", col =  "springgreen2", ylim = c(.8,1.25), ylab = "", axes = F,log = "y",
                                                                    yaxt = "n", pch = 16, lwd = 2, cex = 1, las = 1, xaxt = "n",xlab = "Year", cex.lab=0.8))
  axis(side = 4, las = 1, tck=-0.01, cex.axis = 0.6, col = "springgreen2", col.axis = "springgreen2")
  axis(side = 1, tck=-0.01, cex.axis = 0.6)
  #mtext(side = 4, line = 2, "Mean Primary Production Ratio", cex = 0.8)
  #mtext(side = 1, "", cex = 0.8, text = "Year",line = 1)
  legend("bottomright",
         legend = c("Copepod Index", "PP Ratio"), col = c("black","springgreen2"),
         bty = "n", lwd = 2, cex=0.5)
})

## Fill the panels
figureX <- fill_panel(figureX, PPcopes, row = 1, column = 1)

Ctyp <- capture_base_plot({ 
  #C. typicus abundance anomaly
  opar <- par(mar = c(4,4.75,2,4))
  soe.plot(SOE.data.2018, "Time", "Centropages typicus abundance anomaly MAB",
           anomaly = T, x.start = 1986, x.line=1, y.line = 1, x.label = 'Year', rel.y.num = 0.6,
           y.label = "Abundance anomaly",  rel.x.num = 0.6, rel.x.text = 0.8, rel.y.text = 0.8)
})

## Fill the panels
figureX <- fill_panel(figureX, Ctyp, row = 1, column = 2)


# groundfish condition
#knitr::include_graphics(file.path(image.dir, 'MAFMC_Fish_Condition_2018.jpg'))

figureX <- fill_panel(figureX, file.path(image.dir,'MAFMC_Fish_Condition_2018_crop.jpg'), scaling = "stretch", row = 2, column = 1)

# groundfish productivity
## Functions for plotting
library(ggplot2)
library(rpart)

#### Adjust plot properties -------------------------------
adjustAxes <- 
  ggplot2::theme(axis.title   = element_text(size = 18),
                 axis.text    = element_text(size = 15),
                 plot.title   = element_text(size = 20))

ggplot <- function(...) { ggplot2::ggplot(...)  + 
    ggplot2::theme_bw() + 
    adjustAxes}


#### Plot stacked bar with cpts for single var ------------
plot_stackbarcpts_single <- function(YEAR, var2bar,
                                     x, xlab, ylab,
                                     titl,
                                     file_suffix,
                                     leg_font_size = 10,
                                     remove_leg = FALSE,
                                     leg_ncol = 1,
                                     wcpts = TRUE,
                                     wdashed = TRUE,
                                     height = 5.5,
                                     width = 8,
                                     filt = TRUE,
                                     label = label,
                                     y.text = y.text) {
  
  dat2bar <- data.frame(YEAR, var2bar,
                        x)
  if (filt == TRUE){mab_species <-  list("SUMMER FLOUNDER","SCUP","BLACK SEA BASS","BLUEFISH",
                                         "NORTHERN SHORTFIN SQUID", "LONGFIN SQUID", "ATLANTIC MACKEREL",
                                         "BUTTERFISH","ATLANTIC SURFCLAM", "OCEAN QUAHOG", "TILEFISH",
                                         "BLUELINE TILEFISH","SPINY DOGFISH", "GOOSEFISH")
  dat2plot <-
    dat2bar %>%
    tidyr::gather(variable, value, -YEAR, -var2bar) %>%
    dplyr::mutate(var2bar = gsub(pattern      = "_", 
                                 replacement  = " ", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl.", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "NS and combined", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "YT", 
                                 replacement  = "Yellowtail", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " GoM", 
                                 replacement  = " GOM", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " by EPU", 
                                 replacement  = "", 
                                 x            = var2bar)) %>%
    filter(var2bar %in% mab_species)
} else if (filt == FALSE){
    dat2plot <-
    dat2bar %>%
    tidyr::gather(variable, value, -YEAR, -var2bar) %>%
    dplyr::mutate(var2bar = gsub(pattern      = "_", 
                                 replacement  = " ", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl.", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "Atl", 
                                 replacement  = "ATLANTIC", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "NS and combined", 
                                 replacement  = "", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = "YT", 
                                 replacement  = "Yellowtail", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " GoM", 
                                 replacement  = " GOM", 
                                 x            = var2bar),
                  var2bar = gsub(pattern      = " by EPU", 
                                 replacement  = "", 
                                 x            = var2bar))
}
  p <-   
    ggplot(dat2plot,
           aes(x = YEAR)) +
    geom_bar(data = dat2plot %>% filter(value > 0),
             aes(y = value, fill = var2bar),
             stat = "identity") +
    geom_bar(data = dat2plot %>% filter(value < 0),
             aes(y = value, fill = var2bar),
             stat = "identity") +
    geom_hline(size = 0.3, aes(yintercept = 0)) +
    xlab(xlab) +
    ylab(ylab) +
    ggtitle(titl) +
    guides(fill = guide_legend(ncol = leg_ncol)) +
    #theme(axis.title   = element_text(size = 16),
    #      axis.text    = element_text(size = 15),
    #      plot.title   = element_text(size = 20),
    #      legend.text  = element_text(size = leg_font_size),
    #      legend.title = element_blank()) +
    theme(axis.title   = element_text(size = 8),
          axis.text    = element_text(size = 6),
          plot.title   = element_text(size = 5),
          legend.text  = element_text(size = leg_font_size),
          legend.title = element_blank()) +
    annotate("text", label = label, x = 1980, y = y.text, size = 4, colour = "black") #size = 8,
  
  if(remove_leg) p <- p + theme(legend.position = "none")
  
  print(p)
  
  #ggsave(plot = p,
  #       filename = "./productivity_all.eps",
  #       width = width,
  #       height = height)
}


bar_dat <-SOE.data.2018[grepl("by EPU",SOE.data.2018$Var) & SOE.data.2018$EPU == "MAB",]

fishprod <-  plot_stackbarcpts_single(YEAR = bar_dat$Time,
                                        var2bar = bar_dat$Var,
                                        x = bar_dat$Value,
                                        leg_font_size = 2,
                                        titl = "",
                                        xlab = "",
                                        ylab = "Small fish per large fish biomass (anomaly)",
                                        height = 5.5,
                                        width = 9,
                                        filt = TRUE,
                                        label = "A",
                                        y.text = 4.5,
                                        remove_leg = TRUE)

# bar_dat <-SOE.data.2018[grepl("by EPU",SOE.data.2018$Var) & SOE.data.2018$EPU == "MAB",]
# plot_stackbarcpts_single(YEAR = bar_dat$Time,
#                          var2bar = bar_dat$Var,
#                          x = bar_dat$Value,
#                          titl = "",
#                          xlab = "",
#                          ylab = "Small fish per large fish biomass (anomaly)",
#                          height = 5.5,
#                          width = 9,
#                          filt = FALSE,
#                          label = "B",
#                          y.text = 10)

figureX <- fill_panel(figureX, fishprod, row = 2, column = 2)

figureX

```

